<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Vehicle Dataset Annotation Tool</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; font-family: system-ui, -apple-system, sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card { background: white; border-radius: 24px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .btn-primary { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 12px 20px; 
            border-radius: 12px; 
            border: none; 
            font-weight: bold; 
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 15px 30px rgba(0,0,0,0.2); }
        .btn-secondary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white; 
            padding: 8px 16px; 
            border-radius: 8px; 
            border: none; 
            font-weight: bold; 
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
        }
        .input-field { 
            padding: 10px 14px; 
            border: 2px solid #e5e7eb; 
            border-radius: 8px; 
            width: 100%; 
            transition: all 0.2s ease;
            font-size: 14px;
        }
        .input-field:focus { border-color: #667eea; outline: none; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .input-small { padding: 8px 12px; font-size: 12px; }
        .image-container {
            position: relative;
            max-width: 100%;
            max-height: 650px;
            overflow: hidden;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .uploaded-image {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 16px;
            transition: transform 0.2s ease;
        }
        .zoom-controls {
            position: absolute;
            bottom: 16px;
            left: 16px;
            display: flex;
            gap: 8px;
            background: rgba(0,0,0,0.8);
            padding: 8px;
            border-radius: 12px;
        }
        .zoom-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.2s ease;
        }
        .zoom-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }
        .zoom-level {
            color: white;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            padding: 0 8px;
            min-width: 50px;
            text-align: center;
        }

        .bbox {
            position: absolute;
            border: 3px solid;
            background-color: rgba(0, 0, 0, 0.1);
            cursor: move;
            pointer-events: all;
            border-radius: 4px;
        }
        .bbox.selected {
            border-width: 4px;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.8);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 15px rgba(255, 255, 255, 0.8); }
            50% { box-shadow: 0 0 25px rgba(255, 255, 255, 1); }
            100% { box-shadow: 0 0 15px rgba(255, 255, 255, 0.8); }
        }

        /* Color coding for different annotation types */
        .bbox.vehicle { 
            border-color: #22c55e; 
            background-color: rgba(34, 197, 94, 0.15);
        }
        .bbox.license_plate { 
            border-color: #3b82f6; 
            background-color: rgba(59, 130, 246, 0.15);
        }
        .bbox.wheel { 
            border-color: #f59e0b; 
            background-color: rgba(245, 158, 11, 0.15);
        }

        .bbox.attachment { 
            border-color: #8b5cf6; 
            background-color: rgba(139, 92, 246, 0.15);
        }

        .bbox-label {
            position: absolute;
            top: -30px;
            left: 0;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            white-space: nowrap;
            z-index: 10;
        }
        .resize-handle {
            position: absolute;
            background: #fff;
            border: 2px solid #3b82f6;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 15;
        }
        .resize-handle:hover {
            background: #3b82f6;
            transform: scale(1.2);
        }
        .resize-handle.nw { top: -5px; left: -5px; cursor: nw-resize; }
        .resize-handle.ne { top: -5px; right: -5px; cursor: ne-resize; }
        .resize-handle.sw { bottom: -5px; left: -5px; cursor: sw-resize; }
        .resize-handle.se { bottom: -5px; right: -5px; cursor: se-resize; }
        .resize-handle.n { top: -5px; left: 50%; transform: translateX(-50%); cursor: n-resize; }
        .resize-handle.s { bottom: -5px; left: 50%; transform: translateX(-50%); cursor: s-resize; }
        .resize-handle.w { top: 50%; left: -5px; transform: translateY(-50%); cursor: w-resize; }
        .resize-handle.e { top: 50%; right: -5px; transform: translateY(-50%); cursor: e-resize; }

        .bbox.editing {
            border-color: #3b82f6 !important;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.6) !important;
        }



        .drop-zone {
            border: 3px dashed #cbd5e1;
            border-radius: 16px;
            padding: 48px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .drop-zone:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }
        .drop-zone.dragover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            transform: scale(1.02);
        }
        .section-header {
            font-size: 16px;
            font-weight: bold;
            margin: 20px 0 12px 0;
            padding: 8px 0;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }
        .form-group {
            margin-bottom: 12px;
        }
        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            font-size: 12px;
            color: #374151;
        }
        .checkbox-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 16px;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px;
            background: #f8fafc;
            border-radius: 6px;
            font-size: 12px;
        }
        .annotation-item {
            padding: 10px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }
        .annotation-item:hover {
            background: #e9ecef;
        }
        .annotation-item.selected {
            background: #fff3cd;
            border-color: #ffc107;
        }
        .annotation-info {
            font-size: 11px;
        }
        .annotation-type {
            font-weight: bold;
            font-size: 12px;
        }
        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 10px;
            cursor: pointer;
        }
        .tabs {
            display: flex;
            background: #f1f5f9;
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 16px;
        }
        .tab {
            flex: 1;
            padding: 8px 12px;
            background: transparent;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .tab.active {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .scrollable-panel {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
            padding-right: 8px;
        }
        .connection-indicator {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #10b981;
            border: 2px solid white;
            font-size: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        /* Fullscreen mode styles */
        .fullscreen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fullscreen-container {
            position: relative;
            width: 95vw;
            height: 95vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .fullscreen-toolbar {
            position: absolute;
            top: 0px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            background: rgba(0, 0, 0, 0.8);
            padding: 12px;
            border-radius: 12px;
            z-index: 10001;
        }

        .fullscreen-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease;
            font-size: 12px;
        }

        .fullscreen-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .fullscreen-btn.active {
            background: rgba(255, 215, 0, 0.8);
        }
    </style>
</head>
<body>
    <script>
        // Password protection - Change the password below
        const correctPassword = "cute1234";
        const userPassword = prompt("🔐 Enter password to access the Vehicle Annotation Tool:");
        
        if (userPassword !== correctPassword) {
            document.body.innerHTML = `
                <div style="display: flex; justify-content: center; align-items: center; height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div style="text-align: center; padding: 40px; background: white; border-radius: 20px; box-shadow: 0 25px 50px rgba(0,0,0,0.3);">
                        <h1 style="color: #dc3545; margin-bottom: 20px;">🚫 Access Denied</h1>
                        <p style="color: #666; margin-bottom: 30px;">Incorrect password. Please contact the administrator for access.</p>
                        <button onclick="location.reload()" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">🔄 Try Again</button>
                    </div>
                </div>
            `;
            throw new Error("Access denied");
        }
    </script>

    <!-- Your existing div starts here -->
    <div id="root"></div>    
    <div id="root"></div>
    
    <script type="text/babel">
        const AdvancedVehicleAnnotationTool = () => {
            const [image, setImage] = React.useState(null);
            const [imagePreview, setImagePreview] = React.useState(null);
            const [isDragging, setIsDragging] = React.useState(false);
            const [showMagnifier, setShowMagnifier] = React.useState(false);
            const [magnifierPosition, setMagnifierPosition] = React.useState({ x: 0, y: 0 });
            const [magnifierImagePosition, setMagnifierImagePosition] = React.useState({ x: 0, y: 0 });
            const magnifierSize = 150;
            const magnificationLevel = 2.5;
            const [zoomLevel, setZoomLevel] = React.useState(1);
            const [panPosition, setPanPosition] = React.useState({ x: 0, y: 0 });
            const [isPanning, setIsPanning] = React.useState(false);
            const [lastPanPoint, setLastPanPoint] = React.useState({ x: 0, y: 0 });
            const [magnifierEnabled, setMagnifierEnabled] = React.useState(false);
            const [isFullscreen, setIsFullscreen] = React.useState(false);
            
            // Annotation states
            const [isDrawing, setIsDrawing] = React.useState(false);
            const [drawingStart, setDrawingStart] = React.useState(null);
            const [currentBox, setCurrentBox] = React.useState(null);
            const [selectedAnnotation, setSelectedAnnotation] = React.useState(null);
            const [annotationType, setAnnotationType] = React.useState('vehicle');
            const [wheelType, setWheelType] = React.useState('single');
            const [activeTab, setActiveTab] = React.useState('basic');
            // Image directory navigation
            const [imageDirectory, setImageDirectory] = React.useState([]);
            const [currentImageIndex, setCurrentImageIndex] = React.useState(0);
            const [selectedDirectory, setSelectedDirectory] = React.useState(null);
            const [saveDirectoryName, setSaveDirectoryName] = React.useState('');
            const [imageAnnotationsMap, setImageAnnotationsMap] = React.useState({});

            // Bbox editing states
            const [isDraggingBox, setIsDraggingBox] = React.useState(false);
            const [isResizingBox, setIsResizingBox] = React.useState(false);
           
            const [resizeHandle, setResizeHandle] = React.useState(null);
            const [initialBoxState, setInitialBoxState] = React.useState(null);
            const [initialMousePos, setInitialMousePos] = React.useState(null);
            const [editingBoxId, setEditingBoxId] = React.useState(null);
            // Undo/Redo functionality
            const [undoHistory, setUndoHistory] = React.useState([]);
            const [redoHistory, setRedoHistory] = React.useState([]);
            const maxHistorySize = 50;
            
            // Complex annotation data
            const [annotations, setAnnotations] = React.useState({
                image: { 
                    filename: "", 
                    width: 1920, 
                    height: 1080, 
                    timestamp: new Date().toISOString() 
                },
                objects: []
            });
            
            // Current annotation form data
            const [vehicleForm, setVehicleForm] = React.useState({
                category: 'car',
                subcategory: '',
                country: 'MY',
                brand: '',
                model: '',
                color: '',
                operator: '',
                number_of_seats: 4,
                view_pose: 'rear',
                direction: 'northbound',
                // Mechanical
                number_of_wheels_visible: 4,
                number_of_axles_inferred: 2,
                number_of_axles_raised: 0,
                truck_trailer_labels_visible: false,
                cargo_present: false,
                // Attributes
                is_taxi: false,
                is_bus: false,
                bus_type: '',
                is_emergency_vehicle: false,
                is_electric: false,
                // License plate
                license_plate_text: '',
                license_plate_country: 'MY',
                license_plate_format: 'standard',
                license_plate_blurred: false,
                license_plate_visible: true,
                chainOfThought: []               
            });
            
            
            const fileInputRef = React.useRef(null);
            const imageRef = React.useRef(null);
            const containerRef = React.useRef(null);
            const fullscreenContainerRef = React.useRef(null);

            
            // Vehicle categories and subcategories
            const vehicleCategories = {
                'Car': ['Sedan', 'Hatchback', 'Coupe', 'Sports', 'Convertible', 'Other'],
                'SUV': ['SUVs', '4x4 Vehicles', 'Other'],
                'MPV_Small': ['Minivans', 'Compact MPVs', 'Honda Freed', 'Toyota Sienta', 'Perodua Alza', 'Proton Exora', 'Mitsubishi Xpander', 'Toyota Veloz', 'Daihatsu Xenia', 'Perodua Aruz', 'Honda BR-V', 'Chery Tiggo 8 Pro', 'Other'],
                'MPV_Big': ['Toyota Alphard', 'Kia Carnival', 'Hyundai Staria', 'Toyota Vellfire', 'Honda Odyssey', 'Nissan Serena', 'Mazda Biante', 'Mercedes-Benz V-Class', 'Maxus G10', 'Ford Tourneo Custom', 'Lexus LM 350h', 'Other'],
                'Pickup_Truck': ['4x4', 'Light Trucks', 'Other'],
                'Bus': ['School', 'City', 'Coach Buses', 'Other'],
                'Motorcycle': ['Motorbikes', 'Scooters', 'Other'],
                'Vans': ['Passenger & Cargo Vans (large)', 'Other'],
                'Lorry': ['2-Axle (4-Wheel Truck)', 'Other'],
                'Small_Truck': ['2-Axle (6 Wheel) Small trucks', 'Cargo', 'Other'],
                'Medium_Truck': ['3-Axle Medium-sized trucks', 'Other'],
                'Large_Truck': ['4-Axle Larger commercial trucks', 'Other'],
                'Heavy_Truck': ['5+ Axle Heavy-duty trucks', 'Other'],
                'Construction_and_Industrial_vehicle': ['Bulldozer', 'Excavator', 'Crane', 'Forklift', 'Dump truck', 'Mixer', 'Roller', 'Tow trucks', 'Other'],
                'Emergency_Vehicle': ['Bomba', 'Polis', 'Ambulance', 'Other']
            };
            
            const directions = ['northbound', 'southbound', 'eastbound', 'westbound', 'towards_camera', 'away_from_camera', 'left_to_right', 'right_to_left', 'unknown'];
            const viewPoses = ['front', 'rear', 'side_left', 'side_right', 'front_left', 'front_right', 'rear_left', 'rear_right'];
            const colors = ['White', 'Black', 'Silver', 'Gray', 'Red', 'Blue', 'Green', 'Yellow', 'Brown', 'Orange', 'Purple', 'Gold', 'Maroon', 'Other'];
            
            const annotationTypes = [
                { type: 'vehicle', icon: '🚗', label: 'Vehicle', color: '#22c55e' },
                { type: 'license_plate', icon: '🔢', label: 'License Plate', color: '#3b82f6' },
                { type: 'wheel', icon: '⚙️', label: 'Wheel', color: '#f59e0b' },
                { type: 'attachment', icon: '🚛', label: 'Attachment', color: '#8b5cf6' }
            ];          
            const handleImageUpload = (file) => {
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            setImage(file);
                            setImagePreview(e.target.result);
                            setAnnotations(prev => ({
                                ...prev,
                                image: {
                                    filename: file.name,
                                    width: img.width,
                                    height: img.height,
                                    timestamp: new Date().toISOString()
                                },
                                objects: []
                            }));
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            };
            
            const handleDirectoryUpload = (files) => {
                const imageFiles = Array.from(files).filter(file => file.type.startsWith('image/'));
                
                if (imageFiles.length === 0) {
                    alert('No image files found in the selected directory!');
                    return;
                }
                
                setImageDirectory(imageFiles);
                setCurrentImageIndex(0);
                
                // Load the first image
                loadImageAtIndex(imageFiles, 0);
            };


            const loadImageAtIndex = (files, index) => {
                const file = files[index];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        setImage(file);
                        setImagePreview(e.target.result);
                        
                        // Check if we have saved annotations for this image
                        const savedData = imageAnnotationsMap[file.name];
                        
                        if (savedData) {
                            // Restore saved annotations
                            setAnnotations(savedData.annotations);
                            setVehicleForm(savedData.vehicleForm);
                            console.log(`📂 Restored ${savedData.annotations.objects.length} annotations for ${file.name}`);
                            // alert(`📂 Restored ${savedData.annotations.objects.length} saved annotations!`); // Removed popup
                        } else {
                            // No saved data, start fresh
                            setAnnotations({
                                image: {
                                    filename: file.name,
                                    width: img.width,
                                    height: img.height,
                                    timestamp: new Date().toISOString()
                                },
                                objects: []
                            });
                            // Reset form to defaults
                            setVehicleForm({
                                category: 'Light Vehicle',
                                subcategory: '',
                                country: 'MY',
                                brand: '',
                                model: '',
                                color: '',
                                operator: '',
                                number_of_seats: 4,
                                view_pose: 'rear',
                                direction: 'northbound',
                                number_of_wheels_visible: 4,
                                number_of_axles_inferred: 2,
                                number_of_axles_raised: 0,
                                truck_trailer_labels_visible: false,
                                cargo_present: false,
                                is_taxi: false,
                                is_bus: false,
                                bus_type: '',
                                is_emergency_vehicle: false,
                                is_electric: false,
                                license_plate_text: '',
                                license_plate_country: 'MY',
                                license_plate_format: 'standard',
                                license_plate_blurred: false,
                                license_plate_visible: true
                            });
                        }
                        
                        setSelectedAnnotation(null);
                        setIsDrawing(false);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            };





            const navigateToImage = (direction) => {
                if (imageDirectory.length === 0) return;
                
                // Save current image annotations before switching
                if (image && annotations.objects.length > 0) {
                    const currentFilename = annotations.image.filename;
                    setImageAnnotationsMap(prev => ({
                        ...prev,
                        [currentFilename]: {
                            annotations: JSON.parse(JSON.stringify(annotations)),
                            vehicleForm: JSON.parse(JSON.stringify(vehicleForm))
                        }
                    }));
                    console.log(`💾 Saved ${annotations.objects.length} annotations for ${currentFilename}`);
                }
                
                let newIndex = currentImageIndex;
                if (direction === 'next') {
                    newIndex = (currentImageIndex + 1) % imageDirectory.length;
                } else if (direction === 'prev') {
                    newIndex = currentImageIndex === 0 ? imageDirectory.length - 1 : currentImageIndex - 1;
                }
                
                setCurrentImageIndex(newIndex);
                loadImageAtIndex(imageDirectory, newIndex);
            };

            // Helper function to show temporary messages under the image
            const showTemporaryMessage = (message) => {
                // Create or update message element
                let messageEl = document.getElementById('temp-save-message');
                if (!messageEl) {
                    messageEl = document.createElement('div');
                    messageEl.id = 'temp-save-message';
                    messageEl.style.cssText = `
                        position: fixed;
                        bottom: 20px;
                        left: 50%;
                        transform: translateX(-50%);
                        background: rgba(0,0,0,0.9);
                        color: white;
                        padding: 12px 20px;
                        border-radius: 8px;
                        font-weight: bold;
                        z-index: 10000;
                        text-align: center;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        max-width: 80%;
                        white-space: pre-line;
                    `;
                    document.body.appendChild(messageEl);
                }
                
                messageEl.textContent = message;
                messageEl.style.display = 'block';
                
                // Hide after 3 seconds
                setTimeout(() => {
                    if (messageEl) {
                        messageEl.style.display = 'none';
                    }
                }, 3000);
            };


            const updateBboxPosition = (id, newBbox) => {
                setAnnotations(prev => ({
                    ...prev,
                    objects: prev.objects.map(obj => 
                        obj.id === id ? { 
                            ...obj, 
                            bbox: [
                                Math.round(newBbox.x),
                                Math.round(newBbox.y),
                                Math.round(newBbox.x + newBbox.width),
                                Math.round(newBbox.y + newBbox.height)
                            ]
                        } : obj
                    )
                }));
            };

            const handleBboxMouseDown = (e, boxId, handle = null) => {
                if (isDrawing && !handle && boxId !== selectedAnnotation) {
                    // If we're in drawing mode, ignore bbox interactions and let drawing happen
                    return;
                }
                e.stopPropagation();
                e.preventDefault();
                
                const mousePos = getImageCoordinates(e);
                const currentBox = annotations.objects.find(obj => obj.id === boxId);
                
                if (!currentBox) return;
                
                // Store initial state for smooth transformations
                setInitialMousePos(mousePos);
                setInitialBoxState({ ...currentBox.bbox });
                setEditingBoxId(boxId);
                setSelectedAnnotation(boxId);
                
                if (handle) {
                    setIsResizingBox(true);
                    setResizeHandle(handle);
                } else {
                    setIsDraggingBox(true);
                }
            };


            const calculateNewBbox = (originalBbox, startMouse, currentMouse, handle) => {
                const deltaX = currentMouse.x - startMouse.x;
                const deltaY = currentMouse.y - startMouse.y;
                
                // Convert array format [x1,y1,x2,y2] to object format {x,y,width,height} for calculations
                const bbox = {
                    x: originalBbox[0],
                    y: originalBbox[1], 
                    width: originalBbox[2] - originalBbox[0],
                    height: originalBbox[3] - originalBbox[1]
                };
                
                let newBbox = { ...bbox };
                
                if (!handle) {
                    // Moving the entire box
                    newBbox.x = Math.max(0, Math.min(bbox.x + deltaX, annotations.image.width - bbox.width));
                    newBbox.y = Math.max(0, Math.min(bbox.y + deltaY, annotations.image.height - bbox.height));
                    return newBbox; // Return as object format for internal use
                }
                
                // Resizing based on handle
                const minSize = 20;
                
                switch (handle) {
                    case 'nw':
                        newBbox.width = Math.max(minSize, bbox.width - deltaX);
                        newBbox.height = Math.max(minSize, bbox.height - deltaY);
                        newBbox.x = bbox.x + (bbox.width - newBbox.width);
                        newBbox.y = bbox.y + (bbox.height - newBbox.height);
                        break;
                    case 'ne':
                        newBbox.width = Math.max(minSize, bbox.width + deltaX);
                        newBbox.height = Math.max(minSize, bbox.height - deltaY);
                        newBbox.y = bbox.y + (bbox.height - newBbox.height);
                        break;
                    case 'sw':
                        newBbox.width = Math.max(minSize, bbox.width - deltaX);
                        newBbox.height = Math.max(minSize, bbox.height + deltaY);
                        newBbox.x = bbox.x + (bbox.width - newBbox.width);
                        break;
                    case 'se':
                        newBbox.width = Math.max(minSize, bbox.width + deltaX);
                        newBbox.height = Math.max(minSize, bbox.height + deltaY);
                        break;
                    case 'n':
                        newBbox.height = Math.max(minSize, bbox.height - deltaY);
                        newBbox.y = bbox.y + (bbox.height - newBbox.height);
                        break;
                    case 's':
                        newBbox.height = Math.max(minSize, bbox.height + deltaY);
                        break;
                    case 'w':
                        newBbox.width = Math.max(minSize, bbox.width - deltaX);
                        newBbox.x = bbox.x + (bbox.width - newBbox.width);
                        break;
                    case 'e':
                        newBbox.width = Math.max(minSize, bbox.width + deltaX);
                        break;
                }
                
                // Ensure bbox stays within image bounds
                newBbox.x = Math.max(0, newBbox.x);
                newBbox.y = Math.max(0, newBbox.y);
                newBbox.width = Math.min(newBbox.width, annotations.image.width - newBbox.x);
                newBbox.height = Math.min(newBbox.height, annotations.image.height - newBbox.y);
                
                return newBbox; // Return as object format for internal use
            };


            const handleDirectorySelect = (e) => {
                const files = e.target.files;
                if (files && files.length > 0) {
                    handleDirectoryUpload(files);
                }
            };
            
            const handleFileSelect = (e) => {
                const file = e.target.files[0];
                if (file) {
                    handleImageUpload(file);
                }
            };

            const handleJsonFileSelect = async (e) => {
                const file = e.target.files[0];
                if (!file || !file.name.endsWith('.json')) {
                    alert('Please select a valid JSON file!');
                    return;
                }
                
                try {
                    const text = await file.text();
                    const jsonData = JSON.parse(text);
                    
                    // Validate JSON structure
                    if (!jsonData.image || !jsonData.objects) {
                        alert('Invalid annotation JSON format!');
                        return;
                    }
                    
                    const imageName = jsonData.image.filename;
                    if (!imageName) {
                        alert('No image filename found in JSON!');
                        return;
                    }
                    
                    // Try to auto-find the image file in the same directory
                    const directory = file.webkitRelativePath ? file.webkitRelativePath.split('/').slice(0, -1).join('/') : '';
                    
                    // Create file input to select from the same directory
                    const imageInput = document.createElement('input');
                    imageInput.type = 'file';
                    imageInput.accept = 'image/*';
                    
                    // Try to find matching image extensions
                    const baseImageName = imageName.split('.')[0];
                    const commonExtensions = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp'];
                    
                    imageInput.onchange = (event) => {
                        const imageFile = event.target.files[0];
                        if (imageFile) {
                            const imageBaseName = imageFile.name.split('.')[0];
                            
                            // Check if it's a reasonable match
                            if (imageBaseName.toLowerCase() !== baseImageName.toLowerCase()) {
                                const proceed = confirm(
                                    `JSON expects image "${imageName}" but you selected "${imageFile.name}". Continue anyway?`
                                );
                                if (!proceed) return;
                            }
                            
                            // Load the image and restore annotations
                            loadImageWithAnnotations(imageFile, jsonData);
                        }
                    };
                    
                    // Show a helpful message and trigger file selection
                    alert(`JSON loaded! Now please select the image file "${imageName}" from the same folder.`);
                    imageInput.click();
                    
                } catch (error) {
                    alert('Error reading JSON file: ' + error.message);
                }
            };

            // Helper function to load image with annotations
            const loadImageWithAnnotations = (imageFile, jsonData) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        setImage(imageFile);
                        setImagePreview(e.target.result);
                        
                        // Restore all annotation data
                        setAnnotations({
                            image: {
                                filename: imageFile.name,
                                width: img.width,
                                height: img.height,
                                timestamp: jsonData.image.timestamp || new Date().toISOString()
                            },
                            objects: jsonData.objects || []
                        });
                        
                        // Restore vehicle form if there's a vehicle annotation
                        const firstVehicle = jsonData.objects?.find(obj => obj.type === 'vehicle');
                        if (firstVehicle) {
                            setVehicleForm({
                                category: firstVehicle.vehicle_info?.category || 'Light Vehicle',
                                subcategory: firstVehicle.vehicle_info?.subcategory || '',
                                country: firstVehicle.vehicle_info?.country || 'MY',
                                brand: firstVehicle.vehicle_info?.brand || '',
                                model: firstVehicle.vehicle_info?.model || '',
                                color: firstVehicle.vehicle_info?.color || '',
                                operator: firstVehicle.vehicle_info?.operator || '',
                                number_of_seats: firstVehicle.vehicle_info?.number_of_seats || 4,
                                view_pose: firstVehicle.view_pose || 'rear',
                                direction: firstVehicle.direction || 'northbound',
                                number_of_wheels_visible: firstVehicle.mechanical?.number_of_wheels_visible || 4,
                                number_of_axles_inferred: firstVehicle.mechanical?.number_of_axles_inferred || 2,
                                number_of_axles_raised: firstVehicle.mechanical?.number_of_axles_raised || 0,
                                truck_trailer_labels_visible: firstVehicle.mechanical?.truck_trailer_labels_visible || false,
                                cargo_present: firstVehicle.mechanical?.cargo_present || false,
                                is_taxi: firstVehicle.attributes?.is_taxi || false,
                                is_bus: firstVehicle.attributes?.is_bus || false,
                                bus_type: firstVehicle.attributes?.bus_type || '',
                                is_emergency_vehicle: firstVehicle.attributes?.is_emergency_vehicle || false,
                                is_electric: firstVehicle.attributes?.is_electric || false,
                                license_plate_text: firstVehicle.license_plate?.text || '',
                                license_plate_country: firstVehicle.license_plate?.country || 'MY',
                                license_plate_format: firstVehicle.license_plate?.format || 'standard',
                                license_plate_blurred: firstVehicle.license_plate?.blurred || false,
                                license_plate_visible: firstVehicle.license_plate?.visible || true
                            });
                        }
                        
                        alert(`Successfully loaded ${jsonData.objects?.length || 0} annotations!`);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(imageFile);
            };  
            const handleDragOver = (e) => {
                e.preventDefault();
                setIsDragging(true);
            };
            
            const handleDragLeave = (e) => {
                e.preventDefault();
                setIsDragging(false);
            };
            
            const handleDrop = (e) => {
                e.preventDefault();
                setIsDragging(false);
                const file = e.dataTransfer.files[0];
                if (file) {
                    handleImageUpload(file);
                }
            };
            
            const loadExampleImage = () => {
                const exampleImageUrl = "data:image/svg+xml,%3csvg width='1200' height='800' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='%23f0f9ff'/%3e%3crect x='200' y='300' width='400' height='200' fill='%23ddd' stroke='%23666' stroke-width='3'/%3e%3crect x='580' y='460' width='80' height='30' fill='%23fff' stroke='%23000' stroke-width='2'/%3e%3ctext x='620' y='480' font-size='14' text-anchor='middle' fill='%23000'%3eWXD1023%3c/text%3e%3ccircle cx='250' cy='480' r='25' fill='%23333'/%3e%3ccircle cx='350' cy='480' r='25' fill='%23333'/%3e%3ccircle cx='450' cy='480' r='25' fill='%23333'/%3e%3ccircle cx='550' cy='480' r='25' fill='%23333'/%3e%3ctext x='600' y='200' font-size='36' text-anchor='middle' fill='%23075985'%3e🚛 Heavy Vehicle Example%3c/text%3e%3ctext x='600' y='250' font-size='18' text-anchor='middle' fill='%236b7280'%3ePrime Mover with Trailer%3c/text%3e%3crect x='650' y='320' width='300' height='160' fill='%23eee' stroke='%23666' stroke-width='2'/%3e%3ctext x='800' y='400' font-size='16' text-anchor='middle' fill='%23666'%3eTrailer%3c/text%3e%3c/svg%3e";
                setImagePreview(exampleImageUrl);
                setAnnotations(prev => ({
                    ...prev,
                    image: {
                        filename: "heavy_vehicle_example.jpg",
                        width: 1200,
                        height: 800,
                        timestamp: new Date().toISOString()
                    },
                    objects: []
                }));
            };
            
    
            const handleMouseMove = (e) => {
                if (!imageRef.current) return;
                
                const imageRect = imageRef.current.getBoundingClientRect();
                const mouseX = e.clientX - imageRect.left;
                const mouseY = e.clientY - imageRect.top;
                
                // Check if mouse is over the image
                if (mouseX >= 0 && mouseX <= imageRect.width && mouseY >= 0 && mouseY <= imageRect.height) {
                    setShowMagnifier(true);
                    
                    // Set magnifier position (offset to avoid covering the area being magnified)
                    setMagnifierPosition({
                        x: e.clientX + 20,
                        y: e.clientY - magnifierSize - 20
                    });
                    
                    // Calculate the area of the image to magnify
                    const scaleX = annotations.image.width / imageRect.width;
                    const scaleY = annotations.image.height / imageRect.height;
                    
                    setMagnifierImagePosition({
                        x: mouseX * scaleX,
                        y: mouseY * scaleY
                    });
                } else {
                    setShowMagnifier(false);
                }
            };

            const handleMouseLeave = () => {
                setShowMagnifier(false);
            };

            // Coordinate calculation

            const getImageCoordinates = (e) => {
                if (!imageRef.current) return { x: 0, y: 0 };
                
                const imageRect = imageRef.current.getBoundingClientRect();
                
                // Get mouse position relative to the image element
                const mouseX = e.clientX - imageRect.left;
                const mouseY = e.clientY - imageRect.top;
                
                // Convert to image coordinates (accounting for image scaling)
                const scaleX = annotations.image.width / imageRect.width;
                const scaleY = annotations.image.height / imageRect.height;
                
                const imageX = mouseX * scaleX;
                const imageY = mouseY * scaleY;
                
                // Clamp to image bounds
                return {
                    x: Math.max(0, Math.min(imageX, annotations.image.width)),
                    y: Math.max(0, Math.min(imageY, annotations.image.height))
                };
};
            // Zoom and pan functionality
            const handleZoomIn = () => setZoomLevel(prev => Math.min(prev * 1.2, 5));
            const handleZoomOut = () => setZoomLevel(prev => Math.max(prev / 1.2, 0.1));
            const handleZoomReset = () => { setZoomLevel(1); setPanPosition({ x: 0, y: 0 }); };

            const handleWheel = (e) => {
                if (!imagePreview) return;
                e.preventDefault();
                e.stopPropagation();
                
                // Only zoom the image if Ctrl key is pressed
                if (!e.ctrlKey) return;
                
                const delta = e.deltaY > 0 ? 0.9 : 1.1;
                const newZoomLevel = Math.min(Math.max(zoomLevel * delta, 0.1), 5);
                
                if (newZoomLevel !== zoomLevel) {
                    // Get appropriate container based on current mode
                    const currentContainer = isFullscreen ? fullscreenContainerRef.current : containerRef.current;
                    if (!currentContainer) return;
                    
                    // Get mouse position relative to container for zoom centering
                    const containerRect = currentContainer.getBoundingClientRect();
                    const mouseX = e.clientX - containerRect.left;
                    const mouseY = e.clientY - containerRect.top;
                    
                    // Calculate new pan position to zoom towards mouse
                    const zoomRatio = newZoomLevel / zoomLevel;
                    const newPanX = mouseX - (mouseX - panPosition.x) * zoomRatio;
                    const newPanY = mouseY - (mouseY - panPosition.y) * zoomRatio;
                    
                    setZoomLevel(newZoomLevel);
                    setPanPosition({ x: newPanX, y: newPanY });
                }
            };

                        
            const handleImageMouseDown = (e) => {
                if (!imageRef.current) return;
                
                // Get the appropriate container ref based on current mode
                const currentContainer = isFullscreen ? fullscreenContainerRef.current : containerRef.current;
                if (!currentContainer) return;
                
                // Only start drawing if we're in drawing mode and clicked on empty space

                if (isDrawing) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const coords = getImageCoordinates(e);
                    setDrawingStart(coords);
                    setCurrentBox({
                        x: coords.x,
                        y: coords.y,
                        width: 0,
                        height: 0
                    });

                } else if (!isDrawing && e.target === imageRef.current) {
                    // Allow panning when not drawing
                    setIsPanning(true);
                    setLastPanPoint({ x: e.clientX, y: e.clientY });
                    e.preventDefault();
                }
            };

      
            // Create advanced annotation object
            const createAnnotation = (bbox) => {
                const baseAnnotation = {
                    id: Date.now() + Math.random(),
                    type: annotationType,
                    bbox: [
                        Math.round(bbox.x),
                        Math.round(bbox.y),
                        Math.round(bbox.x + bbox.width),
                        Math.round(bbox.y + bbox.height)
                    ]
                };
                
                if (annotationType === 'vehicle') {
                    return {
                        ...baseAnnotation,
                        view_pose: vehicleForm.view_pose,
                        direction: vehicleForm.direction,
                        vehicle_info: {
                            category: vehicleForm.category,
                            subcategory: vehicleForm.subcategory,
                            country: vehicleForm.country,
                            brand: vehicleForm.brand,
                            model: vehicleForm.model,
                            color: vehicleForm.color,
                            operator: vehicleForm.operator,
                            number_of_seats: vehicleForm.number_of_seats
                        },
                        mechanical: {
                            number_of_wheels_visible: vehicleForm.number_of_wheels_visible,
                            number_of_axles_inferred: vehicleForm.number_of_axles_inferred,
                            number_of_axles_raised: vehicleForm.number_of_axles_raised,
                            truck_trailer_labels_visible: vehicleForm.truck_trailer_labels_visible,
                            cargo_present: vehicleForm.cargo_present
                        },
                        attributes: {
                            is_taxi: vehicleForm.is_taxi,
                            is_bus: vehicleForm.is_bus,
                            bus_type: vehicleForm.bus_type,
                            is_emergency_vehicle: vehicleForm.is_emergency_vehicle,
                            is_electric: vehicleForm.is_electric
                        },
                        license_plate: vehicleForm.license_plate_visible ? {
                            bbox: [0, 0, 0, 0], // Will be updated when license plate annotation is added
                            text: vehicleForm.license_plate_text,
                            country: vehicleForm.license_plate_country,
                            format: vehicleForm.license_plate_format,
                            blurred: vehicleForm.license_plate_blurred,
                            visible: vehicleForm.license_plate_visible
                        } : null,
                        wheels: [],
                        axles: [],
                        attachments: [],
                        CoT: Array.isArray(vehicleForm.chainOfThought) ? vehicleForm.chainOfThought.filter(line => line.trim() !== '') : []
                    };
                }
                if (annotationType === 'wheel') {
                    return {
                        ...baseAnnotation,
                        type: wheelType === 'double' ? 'doubleWheel' : 'singleWheel',
                        parent_id: null
                    };
                }

                return {
                    ...baseAnnotation,
                    parent_id: null,
                    attributes: {}
                };
            };
            // Function to update existing annotation with current form data
            const updateSelectedAnnotationWithForm = () => {
                if (!selectedAnnotation) {
                    alert('Please select an annotation first!');
                    return;
                }
                
                const selectedObj = annotations.objects.find(obj => obj.id === selectedAnnotation);
                if (!selectedObj) {
                    alert('Selected annotation not found!');
                    return;
                }
                
                // Only update if it's a vehicle annotation
                if (selectedObj.type !== 'vehicle') {
                    alert('💡 This button only updates vehicle annotations!\n\nFor other types:\n• Use keyboard shortcuts (1,2,3,4,5)\n• Or use the type dropdown in "Selected Annotation" section');
                    return;
                }
                
                // Save to history before updating
                saveToHistory(annotations);
                
                // Update the vehicle annotation with form data
                setAnnotations(prev => ({
                    ...prev,
                    objects: prev.objects.map(obj => {
                        if (obj.id === selectedAnnotation) {
                            return {
                                ...obj,
                                view_pose: vehicleForm.view_pose,
                                direction: vehicleForm.direction,
                                vehicle_info: {
                                    ...obj.vehicle_info,
                                    category: vehicleForm.category,
                                    subcategory: vehicleForm.subcategory,
                                    brand: vehicleForm.brand,
                                    color: vehicleForm.color,
                                    operator: vehicleForm.operator,
                                    number_of_seats: vehicleForm.number_of_seats
                                },
                                mechanical: {
                                    ...obj.mechanical,
                                    number_of_wheels_visible: vehicleForm.number_of_wheels_visible,
                                    number_of_axles_inferred: vehicleForm.number_of_axles_inferred,
                                    number_of_axles_raised: vehicleForm.number_of_axles_raised,
                                    truck_trailer_labels_visible: vehicleForm.truck_trailer_labels_visible,
                                    cargo_present: vehicleForm.cargo_present
                                },
                                attributes: {
                                    ...obj.attributes,
                                    is_taxi: vehicleForm.is_taxi,
                                    is_bus: vehicleForm.is_bus,
                                    bus_type: vehicleForm.bus_type,
                                    is_emergency_vehicle: vehicleForm.is_emergency_vehicle,
                                    is_electric: vehicleForm.is_electric
                                },
                                license_plate: vehicleForm.license_plate_text ? {
                                    text: vehicleForm.license_plate_text,
                                    country: vehicleForm.license_plate_country,
                                    format: vehicleForm.license_plate_format,
                                    blurred: vehicleForm.license_plate_blurred,
                                    visible: vehicleForm.license_plate_visible
                                } : obj.license_plate,
                                CoT: vehicleForm.chainOfThought ? [vehicleForm.chainOfThought] : obj.CoT
                            };
                        }
                        return obj;
                    })
                }));
                
                alert('Vehicle annotation updated successfully! 🎉');
            };


            const deleteAnnotation = (id) => {
                setAnnotations(prev => ({
                    ...prev,
                    objects: prev.objects.filter(obj => obj.id !== id)
                }));
                setSelectedAnnotation(null);
            };

            // Save state to history for undo functionality
            const saveToHistory = (currentState) => {
                setUndoHistory(prev => {
                    const newHistory = [...prev, JSON.parse(JSON.stringify(currentState))];
                    // Keep only last maxHistorySize states
                    return newHistory.slice(-maxHistorySize);
                });
                setRedoHistory([]); // Clear redo history when new action is performed
            };

            // Undo function
            const undo = () => {
                if (undoHistory.length === 0) return;
                
                const previousState = undoHistory[undoHistory.length - 1];
                const currentState = JSON.parse(JSON.stringify(annotations));
                
                setRedoHistory(prev => [currentState, ...prev.slice(0, maxHistorySize - 1)]);
                setUndoHistory(prev => prev.slice(0, -1));
                setAnnotations(previousState);
                setSelectedAnnotation(null);
            };

            // Handle keyboard shortcuts
            React.useEffect(() => {
                const handleKeyDown = (e) => {
                    // Ignore keyboard shortcuts when user is typing in input fields
                    const activeElement = document.activeElement;
                    const isTyping = activeElement && (
                        activeElement.tagName === 'INPUT' || 
                        activeElement.tagName === 'TEXTAREA' || 
                        activeElement.tagName === 'SELECT' ||
                        activeElement.isContentEditable
                    );
                    
                    // If user is typing, only allow Escape key to work
                    if (isTyping && e.key !== 'Escape') {
                        return;
                    }
                    // Delete selected annotation with Delete or Backspace
                    if ((e.key === 'Delete' || e.key === 'Backspace') && selectedAnnotation) {
                        e.preventDefault();
                        saveToHistory(annotations);
                        deleteAnnotation(selectedAnnotation);
                    }

                    // ADD THESE NEW KEYBOARD SHORTCUTS HERE
                    // Change to vehicle type with '1' key
                    if (e.key === '1' && selectedAnnotation) {
                        e.preventDefault();
                        saveToHistory(annotations);
                        setAnnotations(prev => ({
                            ...prev,
                            objects: prev.objects.map(obj => 
                                obj.id === selectedAnnotation 
                                    ? { ...obj, type: 'vehicle' }
                                    : obj
                            )
                        }));
                    }

                    // Change to license plate with '2' key
                    if (e.key === '2' && selectedAnnotation) {
                        e.preventDefault();
                        saveToHistory(annotations);
                        setAnnotations(prev => ({
                            ...prev,
                            objects: prev.objects.map(obj => 
                                obj.id === selectedAnnotation 
                                    ? { ...obj, type: 'license_plate' }
                                    : obj
                            )
                        }));
                    }

                    // Change to single wheel with '3' key
                    if (e.key === '3' && selectedAnnotation) {
                        e.preventDefault();
                        saveToHistory(annotations);
                        setAnnotations(prev => ({
                            ...prev,
                            objects: prev.objects.map(obj => 
                                obj.id === selectedAnnotation 
                                    ? { ...obj, type: 'wheel', wheel_type: 'single' }
                                    : obj
                            )
                        }));
                    }


                    // Change to double wheel with '4' key
                    if (e.key === '4' && selectedAnnotation) {
                        e.preventDefault();
                        saveToHistory(annotations);
                        setAnnotations(prev => ({
                            ...prev,
                            objects: prev.objects.map(obj => 
                                obj.id === selectedAnnotation 
                                    ? { ...obj, type: 'wheel', wheel_type: 'double' }
                                    : obj
                            )
                        }));
                    }
                    // Change to attachment with '4' key
                    if (e.key === '5' && selectedAnnotation) {
                        e.preventDefault();
                        saveToHistory(annotations);
                        setAnnotations(prev => ({
                            ...prev,
                            objects: prev.objects.map(obj => 
                                obj.id === selectedAnnotation 
                                    ? { ...obj, type: 'attachment' }
                                    : obj
                            )
                        }));
                    }
                    
                    // Undo with Ctrl+Z
                    if (e.ctrlKey && e.key === 'z' && !e.shiftKey) {
                        e.preventDefault();
                        undo();
                    }
                    
                    // Redo with Ctrl+Y or Ctrl+Shift+Z
                    if ((e.ctrlKey && e.key === 'y') || (e.ctrlKey && e.shiftKey && e.key === 'z')) {
                        e.preventDefault();
                        redo();
                    }
                    
                    // Escape to cancel drawing, deselect, or exit fullscreen
                    if (e.key === 'Escape') {
                        if (isFullscreen) {
                            setIsFullscreen(false);
                        } else if (isDrawing) {
                            setIsDrawing(false);
                            setCurrentBox(null);
                            setDrawingStart(null);
                        } else {
                            setSelectedAnnotation(null);
                        }
                    }

                    // Toggle drawing mode with 'W' key
                    if (e.key === 'w' || e.key === 'W') {
                        e.preventDefault();
                        setIsDrawing(prev => !prev);
                        // Clear any current drawing when toggling
                        setCurrentBox(null);
                        setDrawingStart(null);
                        // Deselect current annotation when entering drawing mode
                        if (!isDrawing) {
                            setSelectedAnnotation(null);
                        }
                    }


                    // Save with 'S' key
                    if (e.key === 's' || e.key === 'S') {
                        e.preventDefault();
                        
                        console.log('🔍 S key pressed!');
                        console.log('📁 selectedDirectory:', selectedDirectory);
                        console.log('🖼️ image:', !!image);
                        console.log('📋 annotations count:', annotations.objects.length);
                        
                        if (!selectedDirectory) {
                            // First press - open directory picker directly
                            console.log('⚠️ No directory selected, showing picker');
                            if ('showDirectoryPicker' in window) {
                                window.showDirectoryPicker()
                                    .then(dirHandle => {
                                        setSelectedDirectory(dirHandle);
                                        setSaveDirectoryName(dirHandle.name);
                                        
                                        // Show success message under the image
                                        showTemporaryMessage(`📁 Save location set to: ${dirHandle.name}\nPress 'S' again to save!`);
                                        console.log('✅ Directory selected:', dirHandle.name);
                                    })
                                    .catch(error => {
                                        if (error.name !== 'AbortError') {
                                            console.error('Error selecting directory:', error);
                                            showTemporaryMessage('⚠️ Directory picker not supported. Use the Select Save Directory button.');
                                        }
                                    });
                            } else {
                                showTemporaryMessage('⚠️ Directory picker not supported. Please use the "📁 Select Save Directory" button!');
                            }
                            return;
                        }
                        
                        // Directory is selected - save immediately!
                        console.log('✅ Directory selected, proceeding to save...');
                        if (image && annotations.objects.length > 0) {
                            console.log('🚀 Calling saveCurrentImageToChosenLocation...');
                            saveCurrentImageToChosenLocation();
                            showTemporaryMessage('✅ Image and JSON saved successfully!');
                        } else {
                            console.log('❌ No image or annotations to save');
                            showTemporaryMessage('❌ No image or annotations to save!');
                        }
                    }


                    // Save all annotated images with 'Ctrl+Shift+S' key
                    if (e.ctrlKey && e.shiftKey && (e.key === 's' || e.key === 'S')) {
                        e.preventDefault();
                        if (imageDirectory.length > 1 && Object.keys(imageAnnotationsMap).length > 0) {
                            // Trigger the save all function
                            const annotatedImages = Object.keys(imageAnnotationsMap);
                            let savedCount = 0;
                            
                            annotatedImages.forEach(async (filename) => {
                                const imageData = imageAnnotationsMap[filename];
                                if (imageData.annotations.objects.length > 0) {
                                    const baseFilename = filename.split('.')[0];
                                    
                                    const jsonData = {
                                        ...imageData.annotations,
                                        export_info: {
                                            tool: "Advanced Vehicle Dataset Annotation Tool",
                                            version: "2.0",
                                            exported_at: new Date().toISOString(),
                                            schema_version: "AVC-ANPR-v2.0",
                                            batch_export: true
                                        }
                                    };
                                    
                                    await saveJsonToChosenLocation(jsonData, `${baseFilename}_annotations.json`);
                                    savedCount++;
                                }
                            });
                            
                            setTimeout(() => {
                                alert(`🎉 Successfully saved ${savedCount} annotated images!`);
                            }, 1000);
                        } else {
                            alert('No annotated images to save!');
                        }
                    }                    
                    // Fullscreen with 'F' key
                    if (e.key === 'f' || e.key === 'F') {
                        e.preventDefault();
                        setIsFullscreen(true);
                    }  
                    // Navigation with arrow keys (only in fullscreen mode with image directory)
                    if (isFullscreen && imageDirectory.length > 1) {
                        if (e.key === 'ArrowLeft') {
                            e.preventDefault();
                            navigateToImage('prev');
                        }
                        
                        if (e.key === 'ArrowRight') {
                            e.preventDefault();
                            navigateToImage('next');
                        }
                    }
                                  
                };

                document.addEventListener('keydown', handleKeyDown);
                return () => document.removeEventListener('keydown', handleKeyDown);
            }, [selectedAnnotation, annotations, isDrawing, undoHistory, redoHistory, isFullscreen, imageDirectory, currentImageIndex]);

                        

            // Redo function
            const redo = () => {
                if (redoHistory.length === 0) return;
                
                const nextState = redoHistory[0];
                const currentState = JSON.parse(JSON.stringify(annotations));
                
                setUndoHistory(prev => [...prev, currentState].slice(-maxHistorySize));
                setRedoHistory(prev => prev.slice(1));
                setAnnotations(nextState);
                setSelectedAnnotation(null);
            };
                        
            
            // Export functionality
            const exportAnnotations = () => {
                const exportData = {
                    ...annotations,
                    export_info: {
                        tool: "Advanced Vehicle Dataset Annotation Tool",
                        version: "2.0",
                        exported_at: new Date().toISOString(),
                        schema_version: "AVC-ANPR-v2.0"
                    }
                };
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], {
                    type: 'application/json'
                });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${annotations.image.filename.split('.')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            };

            const saveCurrentImage = () => {
                if (!image || annotations.objects.length === 0) {
                    alert('No annotations to save for current image!');
                    return;
                }
                
                // Save JSON data
                const currentImageData = {
                    ...annotations,
                    export_info: {
                        tool: "Advanced Vehicle Dataset Annotation Tool",
                        version: "2.0",
                        exported_at: new Date().toISOString(),
                        schema_version: "AVC-ANPR-v2.0",
                        image_index: currentImageIndex + 1,
                        total_images: imageDirectory.length
                    }
                };
                
                const blob = new Blob([JSON.stringify(currentImageData, null, 2)], {
                    type: 'application/json'
                });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${annotations.image.filename.split('.')[0]}_annotations.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                // Save annotated image with bboxes drawn on it
                saveAnnotatedImage();
            };

            const saveAnnotatedImage = () => {
                if (!imageRef.current) return;
                
                // Create a canvas to draw the image with annotations
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Set canvas size to match original image
                canvas.width = annotations.image.width;
                canvas.height = annotations.image.height;
                
                // Create a new image to draw on canvas
                const img = new Image();
                img.onload = () => {
                    // Draw the original image
                    ctx.drawImage(img, 0, 0);
                    
                    // Draw all bounding boxes
                    annotations.objects.forEach(obj => {
                        const bbox = obj.bbox; // This is [x1, y1, x2, y2] format
                        
                        // Set bbox style based on type
                        const typeColors = {
                            'vehicle': '#22c55e',
                            'license_plate': '#3b82f6', 
                            'wheel': '#f59e0b',
                            'attachment': '#8b5cf6'
                        };
                        
                        ctx.strokeStyle = typeColors[obj.type] || '#22c55e';
                        ctx.lineWidth = 4;
                        ctx.fillStyle = typeColors[obj.type] + '20'; // Semi-transparent fill
                        
                        // Draw bbox rectangle - FIXED: Convert [x1,y1,x2,y2] to x,y,width,height
                        const x = bbox[0];
                        const y = bbox[1]; 
                        const width = bbox[2] - bbox[0];  // x2 - x1
                        const height = bbox[3] - bbox[1]; // y2 - y1

                        ctx.fillRect(x, y, width, height);
                        ctx.strokeRect(x, y, width, height);
                        
                        // Draw label
                        ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                        ctx.font = 'bold 20px Arial';
                        
                        let labelText = obj.type.replace('_', ' ').toUpperCase();
                        if (obj.type === 'vehicle') {
                            labelText = `${labelText} (${obj.vehicle_info?.category || 'VEHICLE'})`;
                        }
                        if (obj.type === 'wheel' && obj.wheel_type) {
                            labelText = `WHEEL (${obj.wheel_type.toUpperCase()})`;
                        }
                        if (obj.license_plate?.text) {
                            labelText += ` - ${obj.license_plate.text}`;
                        }
                        
                        const textWidth = ctx.measureText(labelText).width;
                        
                        // Label background
                        ctx.fillRect(x, y - 30, textWidth + 10, 30);

                        // Label text
                        ctx.fillStyle = 'white';
                        ctx.fillText(labelText, x + 5, y - 8);
                    });
                    
                    // Convert canvas to blob and download
                    canvas.toBlob((blob) => {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `${annotations.image.filename.split('.')[0]}_annotated.${annotations.image.filename.split('.').pop()}`;
                        a.click();
                        URL.revokeObjectURL(url);
                    }, 'image/png');
                };
                
                img.src = imagePreview;
            };

            const exportAllProgress = () => {
                // This could be expanded to save all annotated images' progress
                const progressData = {
                    directory_info: {
                        total_images: imageDirectory.length,
                        current_index: currentImageIndex,
                        exported_at: new Date().toISOString()
                    },
                    current_image: annotations
                };
                
                const blob = new Blob([JSON.stringify(progressData, null, 2)], {
                    type: 'application/json'
                });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `annotation_progress_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            };

            // Modern File System Access API functions
            const saveJsonToChosenLocation = async (data, suggestedName) => {
                try {
                    // Try modern File System Access API first
                    if ('showSaveFilePicker' in window && window.isSecureContext) {
                        try {
                            const fileHandle = await window.showSaveFilePicker({
                                suggestedName: suggestedName,
                                types: [{
                                    description: 'JSON files',
                                    accept: { 'application/json': ['.json'] }
                                }]
                            });
                            
                            const writable = await fileHandle.createWritable();
                            await writable.write(JSON.stringify(data, null, 2));
                            await writable.close();
                            
                            alert('JSON file saved successfully to chosen location!');
                            return true;
                        } catch (pickerError) {
                            // If user cancels or API fails, fall back to download
                            if (pickerError.name === 'AbortError') {
                                return false; // User cancelled
                            }
                            console.log('File picker failed, using download fallback:', pickerError.message);
                        }
                    }
                    
                    // Fallback to download method
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = suggestedName;
                    a.click();
                    URL.revokeObjectURL(url);
                    alert('JSON file downloaded to your Downloads folder!');
                    return true;
                    
                } catch (error) {
                    alert('Error saving file: ' + error.message);
                    return false;
                }
            };


            const saveImageToChosenLocation = async (canvas, suggestedName) => {
                try {
                    // Try modern File System Access API first
                    if ('showSaveFilePicker' in window && window.isSecureContext) {
                        try {
                            const fileHandle = await window.showSaveFilePicker({
                                suggestedName: suggestedName,
                                types: [{
                                    description: 'PNG images',
                                    accept: { 'image/png': ['.png'] }
                                }]
                            });
                            
                            return new Promise((resolve) => {
                                canvas.toBlob(async (blob) => {
                                    try {
                                        const writable = await fileHandle.createWritable();
                                        await writable.write(blob);
                                        await writable.close();
                                        alert('Annotated image saved successfully to chosen location!');
                                        resolve(true);
                                    } catch (error) {
                                        alert('Error writing file: ' + error.message);
                                        resolve(false);
                                    }
                                }, 'image/png');
                            });
                        } catch (pickerError) {
                            // If user cancels or API fails, fall back to download
                            if (pickerError.name === 'AbortError') {
                                return false; // User cancelled
                            }
                            console.log('File picker failed, using download fallback:', pickerError.message);
                        }
                    }
                    
                    // Fallback to download method
                    return new Promise((resolve) => {
                        canvas.toBlob((blob) => {
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = suggestedName;
                            a.click();
                            URL.revokeObjectURL(url);
                            alert('Annotated image downloaded to your Downloads folder!');
                            resolve(true);
                        }, 'image/png');
                    });
                    
                } catch (error) {
                    alert('Error saving image: ' + error.message);
                    return false;
                }
            };


            const saveToSelectedDirectory = async (data, filename, isImage = false) => {
                try {
                    if (selectedDirectory && 'showDirectoryPicker' in window) {
                        // Save to selected directory
                        const fileHandle = await selectedDirectory.getFileHandle(filename, { create: true });
                        const writable = await fileHandle.createWritable();
                        
                        if (isImage) {
                            // For images, data is already a blob
                            await writable.write(data);
                        } else {
                            // For JSON
                            await writable.write(JSON.stringify(data, null, 2));
                        }
                        
                        await writable.close();
                        console.log(`✅ Saved ${filename} to ${saveDirectoryName}`);
                        return true;
                    } else {
                        // Fallback to download
                        if (isImage) {
                            const url = URL.createObjectURL(data);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = filename;
                            a.click();
                            URL.revokeObjectURL(url);
                        } else {
                            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = filename;
                            a.click();
                            URL.revokeObjectURL(url);
                        }
                        return true;
                    }
                } catch (error) {
                    console.error('Error saving file:', error);
                    return false;
                }
            };            

            const saveCurrentImageToChosenLocation = async () => {
                if (!image || annotations.objects.length === 0) {
                    alert('No annotations to save for current image!');
                    return;
                }
                
                // CHECK IF DIRECTORY IS SELECTED FIRST
                if (!selectedDirectory) {
                    alert('⚠️ Please select a save directory first using the "📁 Select Save Directory" button!');
                    return;
                }
                
                const baseFilename = annotations.image.filename.split('.')[0];
                
                // Save JSON
                const currentImageData = {
                    ...annotations,
                    export_info: {
                        tool: "Advanced Vehicle Dataset Annotation Tool",
                        version: "2.0",
                        exported_at: new Date().toISOString(),
                        schema_version: "AVC-ANPR-v2.0"
                    }
                };
                
                const jsonSaved = await saveToSelectedDirectory(currentImageData, `${baseFilename}_annotations.json`);
                
                if (jsonSaved) {
                    // Save annotated image
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = annotations.image.width;
                    canvas.height = annotations.image.height;
                    
                    const img = new Image();
                    img.onload = async () => {
                        ctx.drawImage(img, 0, 0);
                        
                        // Draw annotations - FIXED VERSION
                        annotations.objects.forEach(obj => {
                            const bbox = obj.bbox; // [x1, y1, x2, y2] format
                            const typeColors = {
                                'vehicle': '#22c55e',
                                'license_plate': '#3b82f6', 
                                'wheel': '#f59e0b',
                                'attachment': '#8b5cf6'
                            };
                            
                            ctx.strokeStyle = typeColors[obj.type] || '#22c55e';
                            ctx.lineWidth = 4;
                            ctx.fillStyle = typeColors[obj.type] + '20';
                            
                            // FIXED: Convert [x1,y1,x2,y2] to x,y,width,height
                            const x = bbox[0];
                            const y = bbox[1];
                            const width = bbox[2] - bbox[0];  // x2 - x1  
                            const height = bbox[3] - bbox[1]; // y2 - y1
                            
                            ctx.fillRect(x, y, width, height);
                            ctx.strokeRect(x, y, width, height);
                            
                            // Draw label
                            ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                            ctx.font = 'bold 16px Arial';
                            
                            let labelText = obj.type.replace('_', ' ').toUpperCase();
                            if (obj.type === 'wheel' && obj.wheel_type) {
                                labelText = `WHEEL (${obj.wheel_type.toUpperCase()})`;
                            }
                            
                            const textWidth = ctx.measureText(labelText).width;
                            ctx.fillRect(x, y - 25, textWidth + 10, 25);
                            ctx.fillStyle = 'white';
                            ctx.fillText(labelText, x + 5, y - 8);
                        });
                        
                        canvas.toBlob(async (blob) => {
                            await saveToSelectedDirectory(blob, `${baseFilename}_annotated.png`, true);
                            console.log(`✅ Saved both JSON and image to ${saveDirectoryName}!`);
                        }, 'image/png');
                    };
                    img.src = imagePreview;
                }
            };

            
            // Mouse event handlers
            React.useEffect(() => {
                const handleGlobalMouseMove = (e) => {
                    if (isPanning) {
                        const deltaX = e.clientX - lastPanPoint.x;
                        const deltaY = e.clientY - lastPanPoint.y;
                        
                        setPanPosition(prev => ({
                            x: prev.x + deltaX,
                            y: prev.y + deltaY
                        }));
                        
                        setLastPanPoint({ x: e.clientX, y: e.clientY });
                    }
                                    
                    if (isDrawing && drawingStart) {
                        const coords = getImageCoordinates(e);
                        const newBox = {
                            x: Math.min(drawingStart.x, coords.x),
                            y: Math.min(drawingStart.y, coords.y),
                            width: Math.abs(coords.x - drawingStart.x),
                            height: Math.abs(coords.y - drawingStart.y)
                        };
                        setCurrentBox(newBox);
                    }
                    
                    // Handle bbox dragging and resizing
                    if ((isDraggingBox || isResizingBox) && editingBoxId && initialBoxState && initialMousePos) {
                        const currentMousePos = getImageCoordinates(e);
                        const newBbox = calculateNewBbox(initialBoxState, initialMousePos, currentMousePos, resizeHandle);
                        updateBboxPosition(editingBoxId, newBbox);
                    }
                };
                
                const handleGlobalMouseUp = () => {
                    if (isPanning) {
                        setIsPanning(false);
                    }                
                 
                    if (isDrawing && drawingStart && currentBox) {
                        if (currentBox.width > 10 && currentBox.height > 10) {
                            // Save current state to history before adding new annotation
                            saveToHistory(annotations);
                            
                            const newAnnotation = createAnnotation(currentBox);
                            setAnnotations(prev => ({
                                ...prev,
                                objects: [...prev.objects, newAnnotation]
                            }));
                            setSelectedAnnotation(newAnnotation.id);
                        }
                        // Clear the drawing states IMMEDIATELY
                        setCurrentBox(null);
                        setDrawingStart(null);
                        // Auto-exit drawing mode after creating annotation
                        setIsDrawing(false);
                    }
                    // Reset bbox editing states
                    if (isDraggingBox || isResizingBox) {
                        setIsDraggingBox(false);
                        setIsResizingBox(false);
                        setEditingBoxId(null);
                        setResizeHandle(null);
                        setInitialBoxState(null);
                        setInitialMousePos(null);
                    }
                };
                
                // Always add event listeners
                document.addEventListener('mousemove', handleGlobalMouseMove);
                document.addEventListener('mouseup', handleGlobalMouseUp);
                
                return () => {
                    document.removeEventListener('mousemove', handleGlobalMouseMove);
                    document.removeEventListener('mouseup', handleGlobalMouseUp);
                };

           
            }, [isDrawing, drawingStart, currentBox, annotationType, vehicleForm, isDraggingBox, isResizingBox, editingBoxId, initialBoxState, initialMousePos, resizeHandle, annotations.objects, isPanning, lastPanPoint]);
            // Force re-render when switching between modes
            React.useEffect(() => {
                // This will trigger a re-render of bboxes when switching modes
                setAnnotations(prev => ({ ...prev }));
            }, [isFullscreen]);



            // Get annotation type icon
            const getAnnotationIcon = (type, wheelType = null) => {
                switch(type) {
                    case 'vehicle': return '1';
                    case 'license_plate': return '2';
                    case 'wheel': return wheelType === 'double' ? '4' : '3';
                    case 'attachment': return '5';
                    default: return '📦';
                }
            };
            
            return (
                <div style={{ minHeight: '100vh', background: 'linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%)' }}>
                    {/* Header */}
                    <div style={{ 
                        background: 'linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #1e3a8a 100%)', 
                        padding: '24px' 
                    }}>
                    <div style={{ maxWidth: '1600px', margin: '0 auto', display: 'flex', alignItems: 'center', gap: '16px' }}>
                        <img 
                            src="./delloyd.jfif" 
                            alt="Delloyd Logo" 
                            style={{
                                width: '80px',
                                height: '80px',
                                objectFit: 'contain'
                            }}
                            onError={(e) => {
                                // Fallback to truck emoji if image fails to load
                                e.target.outerHTML = '<div style="width: 56px; height: 56px; background: rgba(255,255,255,0.2); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 28px;">🚛</div>';
                            }}
                        />
                        
                        <div>
                            <h1 style={{ color: 'white', fontSize: '36px', fontWeight: 'bold', margin: 0 }}>
                                Advanced Vehicle Dataset Tool
                            </h1>
                            <p style={{ color: 'rgba(255,255,255,0.8)', fontSize: '16px', margin: '4px 0 0 0' }}>
                                Professional AVC & ANPR Dataset Creation Platform
                            </p>
                        </div>
                    </div>
                    </div>
                    
                    <div style={{ maxWidth: '1600px', margin: '0 auto', padding: '24px', display: 'grid', gridTemplateColumns: '320px 1fr 350px', gap: '24px' }}>
                        {/* Left Panel - Image & Drawing Controls */}
                        <div className="card" style={{ padding: '24px', height: 'fit-content' }}>
                            <h2 style={{ fontSize: '20px', fontWeight: 'bold', marginBottom: '20px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                                📁 Image & JSON Upload
                            </h2>



                            {/* Compact Upload Section */}
                            <div style={{ marginBottom: '16px' }}>
                                {/* Single Image Upload - Compact */}
                                <div style={{ marginBottom: '8px', padding: '8px', background: '#f8fafc', borderRadius: '6px', border: '1px solid #e2e8f0' }}>
                                    <div style={{ fontSize: '10px', color: '#374151', marginBottom: '4px', fontWeight: 'bold', display: 'flex', alignItems: 'center', gap: '4px' }}>
                                        📷 Single Image
                                    </div>
                                    <input 
                                        ref={fileInputRef}
                                        type="file" 
                                        accept="image/*" 
                                        onChange={handleFileSelect}
                                        className="input-field"
                                        style={{ padding: '6px 8px', fontSize: '11px' }}
                                    />
                                </div>

                                {/* JSON with Auto Image Detection - Compact */}
                                <div style={{ marginBottom: '8px', padding: '8px', background: '#fff3cd', borderRadius: '6px', border: '1px solid #ffd60a' }}>
                                    <div style={{ fontSize: '10px', color: '#8b5a2b', marginBottom: '4px', fontWeight: 'bold', display: 'flex', alignItems: 'center', gap: '4px' }}>
                                        📄 JSON + Auto Image
                                    </div>
                                    <input 
                                        type="file" 
                                        accept=".json"
                                        onChange={handleJsonFileSelect}
                                        className="input-field"
                                        style={{ padding: '6px 8px', fontSize: '11px' }}
                                    />
                                </div>

                                {/* Directory Upload - Compact */}
                                <div style={{ marginBottom: '8px', padding: '8px', background: '#f0f9ff', borderRadius: '6px', border: '1px solid #0ea5e9' }}>
                                    <div style={{ fontSize: '10px', color: '#0c4a6e', marginBottom: '4px', fontWeight: 'bold', display: 'flex', alignItems: 'center', gap: '4px' }}>
                                        📁 Folder/Directory
                                    </div>
                                    <div style={{ position: 'relative' }}>
                                        <input 
                                            type="file" 
                                            webkitdirectory="true"
                                            directory="true"
                                            multiple
                                            accept="image/*"
                                            onChange={handleDirectorySelect}
                                            className="input-field"
                                            style={{ opacity: 0, position: 'absolute', zIndex: -1, padding: '6px 8px', fontSize: '11px' }}
                                            id="directory-input"
                                        />
                                        <label 
                                            htmlFor="directory-input"
                                            className="input-field"
                                            style={{ 
                                                display: 'block', 
                                                cursor: 'pointer', 
                                                textAlign: 'center',
                                                backgroundColor: 'white',
                                                border: '2px dashed #0ea5e9',
                                                color: '#0c4a6e',
                                                padding: '6px 8px',
                                                fontSize: '11px'
                                            }}
                                        >
                                            {imageDirectory.length > 0 ? `📁 ${imageDirectory.length} images` : '📁 Choose Folder'}
                                        </label>
                                    </div>
                                </div>
                                
                                {/* Example Button - Compact */}
                                <button 
                                    onClick={loadExampleImage}
                                    className="btn-primary" 
                                    style={{ width: '100%', padding: '8px 12px', fontSize: '11px', marginBottom: '12px' }}
                                >
                                    ⚡ Example Vehicle
                                </button>
                            </div>

                            {/* Chain of Thought (CoT) Section - Now in Left Panel */}
                            <div style={{ marginBottom: '16px' }}>
                                <div style={{ fontSize: '14px', fontWeight: 'bold', marginBottom: '8px', display: 'flex', alignItems: 'center', gap: '6px', color: '#374151' }}>
                                    🧠 Chain of Thought (CoT)
                                    <button 
                                        onClick={() => alert(`📝 CoT Examples:\n\n"Volvo prime mover detected pulling a box-type trailer."\n"Main vehicle plate WXD1023 and trailer plate TRL9087 are both visible."\n"Total of 10 wheels seen; one axle appears lifted."\n"Trailer is loaded (cargo flag = true)."\n"No bus, taxi, or emergency markings detected."\n\n💡 Each line will be saved separately in the JSON!`)}
                                        style={{
                                            background: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '50%',
                                            width: '20px',
                                            height: '20px',
                                            fontSize: '12px',
                                            cursor: 'pointer',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            fontWeight: 'bold'
                                        }}
                                        title="Click for CoT examples"
                                    >
                                        !
                                    </button>
                                </div>
                                <div style={{ 
                                    background: '#f8f9fa', 
                                    border: '1px solid #e9ecef', 
                                    borderRadius: '8px',
                                    padding: '10px'
                                }}>
                                    <textarea 
                                        className="input-field"
                                        placeholder="Write your reasoning, observations, or notes... (Press Enter for new lines)"
                                        value={Array.isArray(vehicleForm.chainOfThought) ? vehicleForm.chainOfThought.join('\n') : (vehicleForm.chainOfThought || '')}
                                        onChange={(e) => {
                                            // Simply split by newlines and save as array
                                            const lines = e.target.value.split('\n');
                                            setVehicleForm(prev => ({ 
                                                ...prev, 
                                                chainOfThought: lines
                                            }));
                                        }}
                                        style={{ 
                                            minHeight: '80px',
                                            resize: 'vertical',
                                            fontSize: '11px',
                                            fontFamily: 'inherit',
                                            padding: '8px'
                                        }}
                                    />
                                    
                                    {/* Add Reasoning Button */}
                                    <button 
                                        onClick={() => {
                                            const currentLines = Array.isArray(vehicleForm.chainOfThought) ? vehicleForm.chainOfThought : [];
                                            
                                            // Add a new empty line for user to type
                                            setVehicleForm(prev => ({ 
                                                ...prev, 
                                                chainOfThought: [...currentLines, ""]
                                            }));
                                            
                                            // Focus the textarea after adding
                                            setTimeout(() => {
                                                const textarea = document.querySelector('textarea[placeholder*="Write your reasoning"]');
                                                if (textarea) {
                                                    textarea.focus();
                                                    textarea.setSelectionRange(textarea.value.length, textarea.value.length);
                                                }
                                            }, 50);
                                        }}
                                        style={{
                                            background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '6px',
                                            padding: '6px 12px',
                                            fontSize: '10px',
                                            fontWeight: 'bold',
                                            cursor: 'pointer',
                                            marginTop: '6px',
                                            width: '100%'
                                        }}
                                    >
                                        ➕ Add Reasoning Line
                                    </button>
                                    
                                    <div style={{ 
                                        fontSize: '9px', 
                                        color: '#6b7280', 
                                        marginTop: '4px',
                                        fontStyle: 'italic' 
                                    }}>
                                        💡 Press Enter for new lines, each line saves separately to JSON.
                                    </div>
                                </div>
                            </div>
                                                        

                            {image && (
                                <div style={{ marginBottom: '20px', padding: '12px', background: '#f0f9ff', borderRadius: '8px', border: '2px solid #0ea5e9' }}>
                                    <div style={{ fontSize: '12px', color: '#0c4a6e', fontWeight: 'bold', marginBottom: '6px' }}>
                                        📸 Image Information
                                    </div>
                                    <div style={{ fontSize: '11px', color: '#075985' }}>
                                        <div><strong>File:</strong> {annotations.image.filename}</div>
                                        <div><strong>Resolution:</strong> {annotations.image.width} × {annotations.image.height}px</div>
                                        {imageDirectory.length > 1 && (
                                            <>
                                                <div><strong>Progress:</strong> {currentImageIndex + 1} of {imageDirectory.length}</div>
                                                <div style={{ color: '#8b5cf6', fontWeight: 'bold' }}>
                                                    <strong>📁 Total Annotated:</strong> {Object.keys(imageAnnotationsMap).filter(filename => imageAnnotationsMap[filename].annotations.objects.length > 0).length} images
                                                </div>
                                            </>
                                        )}
                                        <div><strong>Current Annotations:</strong> {annotations.objects.length}</div>
                                        {imageAnnotationsMap[annotations.image.filename] && (
                                            <div style={{ color: '#10b981', fontWeight: 'bold' }}>
                                                💾 {imageAnnotationsMap[annotations.image.filename].annotations.objects.length} saved annotations
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                            
                            <div className="section-header">
                                🎯 Annotation Controls
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Annotation Type</label>
                                <select 
                                    className="input-field input-small"
                                    value={annotationType}
                                    onChange={(e) => setAnnotationType(e.target.value)}
                                >
                                    <option value="vehicle">🚗 Vehicle</option>
                                    <option value="license_plate">🔢 License Plate</option>
                                    <option value="wheel">⚙️ Wheel</option>
                                    <option value="attachment">🚛 Attachment/Trailer</option>
                                </select>
                            </div>

                            {/* Wheel Type Selector - only show when wheel is selected */}
                            {annotationType === 'wheel' && (
                                <div className="form-group">
                                    <label className="form-label">Wheel Type</label>
                                    <div style={{ display: 'flex', gap: '8px' }}>
                                        <button 
                                            className={`btn-secondary ${wheelType === 'single' ? 'active' : ''}`}
                                            style={{ 
                                                flex: 1,
                                                background: wheelType === 'single' ? 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)' : 'linear-gradient(135deg, #94a3b8 0%, #64748b 100%)',
                                                fontSize: '11px',
                                                padding: '6px 12px'
                                            }}
                                            onClick={() => setWheelType('single')}
                                        >
                                            🔘 Single Wheel
                                        </button>
                                        <button 
                                            className={`btn-secondary ${wheelType === 'double' ? 'active' : ''}`}
                                            style={{ 
                                                flex: 1,
                                                background: wheelType === 'double' ? 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)' : 'linear-gradient(135deg, #94a3b8 0%, #64748b 100%)',
                                                fontSize: '11px',
                                                padding: '6px 12px'
                                            }}
                                            onClick={() => setWheelType('double')}
                                        >
                                            ⚫⚫ Double Wheel
                                        </button>
                                    </div>
                                </div>
                            )}
                            
                            <div style={{ marginBottom: '20px' }}>
                                <button 
                                    className="btn-primary" 
                                    style={{ 
                                        width: '100%', 
                                        marginBottom: '10px',
                                        background: isDrawing ? 'linear-gradient(135deg, #ff6b00 0%, #ff8f00 100%)' : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
                                    }}
                                    onClick={() => setIsDrawing(!isDrawing)}
                                    disabled={!imagePreview}
                                >
                                    {isDrawing ? '🎯 Drawing Mode ON (Press W to exit)' : '✏️ Start Drawing (Press W)'}
                                </button>
                                
                                {annotations.objects.length > 0 && (
                                    <button 
                                        onClick={() => {
                                            saveToHistory(annotations);
                                            setAnnotations(prev => ({ ...prev, objects: [] }));
                                            setSelectedAnnotation(null);
                                        }}
                                        style={{ 
                                            width: '100%', 
                                            padding: '10px', 
                                            background: 'linear-gradient(135deg, #ff4757 0%, #ff3838 100%)', 
                                            color: 'white', 
                                            border: 'none', 
                                            borderRadius: '8px', 
                                            fontWeight: 'bold', 
                                            cursor: 'pointer',
                                            fontSize: '12px'
                                        }}
                                    >
                                        🗑️ Clear All Annotations
                                    </button>
                                )}
                            </div>
                            
                            {/* Annotations List */}
                            {annotations.objects.length > 0 && (
                                <div>
                                    <div className="section-header">
                                        📋 Annotations ({annotations.objects.length})
                                    </div>
                                    <div style={{ maxHeight: '300px', overflowY: 'auto' }}>
                                        {annotations.objects.map((obj, index) => (
                                            <div 
                                                key={obj.id}
                                                className={`annotation-item ${selectedAnnotation === obj.id ? 'selected' : ''}`}
                                                onClick={() => {
                                                    setSelectedAnnotation(obj.id);
                                                    // Auto-load vehicle form when selecting a vehicle annotation
                                                    if (obj.type === 'vehicle') {
                                                        setVehicleForm({
                                                            category: obj.vehicle_info?.category || 'Light Vehicle',
                                                            subcategory: obj.vehicle_info?.subcategory || '',
                                                            country: obj.vehicle_info?.country || 'MY',
                                                            brand: obj.vehicle_info?.brand || '',
                                                            model: obj.vehicle_info?.model || '',
                                                            color: obj.vehicle_info?.color || '',
                                                            operator: obj.vehicle_info?.operator || '',
                                                            number_of_seats: obj.vehicle_info?.number_of_seats || 4,
                                                            view_pose: obj.view_pose || 'rear',
                                                            direction: obj.direction || 'northbound',
                                                            number_of_wheels_visible: obj.mechanical?.number_of_wheels_visible || 4,
                                                            number_of_axles_inferred: obj.mechanical?.number_of_axles_inferred || 2,
                                                            number_of_axles_raised: obj.mechanical?.number_of_axles_raised || 0,
                                                            truck_trailer_labels_visible: obj.mechanical?.truck_trailer_labels_visible || false,
                                                            cargo_present: obj.mechanical?.cargo_present || false,
                                                            is_taxi: obj.attributes?.is_taxi || false,
                                                            is_bus: obj.attributes?.is_bus || false,
                                                            bus_type: obj.attributes?.bus_type || '',
                                                            is_emergency_vehicle: obj.attributes?.is_emergency_vehicle || false,
                                                            is_electric: obj.attributes?.is_electric || false,
                                                            license_plate_text: obj.license_plate?.text || '',
                                                            license_plate_country: obj.license_plate?.country || 'MY',
                                                            license_plate_format: obj.license_plate?.format || 'standard',
                                                            license_plate_blurred: obj.license_plate?.blurred || false,
                                                            license_plate_visible: obj.license_plate?.visible !== false
                                                        });
                                                    }
                                                }}                                                
                                            >
                                                <div>  
                                                    <div className="annotation-type">
                                                        {getAnnotationIcon(obj.type, obj.wheel_type)} {obj.type.replace('_', ' ').toUpperCase()}
                                                        {obj.type === 'wheel' && obj.wheel_type && ` (${obj.wheel_type.toUpperCase()})`}
                                                        {obj.type === 'wheel' && obj.wheel_type && (
                                                            <span style={{ fontSize: '10px', color: '#6c757d', marginLeft: '4px' }}>
                                                                ({obj.wheel_type.toUpperCase()})
                                                            </span>
                                                        )}
                                                    </div>
                                                    <div className="annotation-info" style={{ color: '#6c757d' }}>
                                                        {Math.round(obj.bbox[2] - obj.bbox[0])}×{Math.round(obj.bbox[3] - obj.bbox[1])}px
                                                        {obj.license_plate?.text && (
                                                            <span> • {obj.license_plate.text}</span>
                                                        )}
                                                    </div>
                                                </div>
                                                <button
                                                    className="delete-btn"
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        saveToHistory(annotations);
                                                        deleteAnnotation(obj.id);
                                                    }}
                                                >
                                                    ✕
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                            

                            {/* Export Controls */}
                            {annotations.objects.length > 0 && (
                                <div style={{ marginTop: '20px' }}>
                                    <div className="section-header">
                                        💾 Save & Export
                                    </div>
                                    {/* Select directory for saving */}
                                    <button 
                                        onClick={async () => {
                                            try {
                                                if ('showDirectoryPicker' in window) {
                                                    const dirHandle = await window.showDirectoryPicker();
                                                    setSelectedDirectory(dirHandle);
                                                    setSaveDirectoryName(dirHandle.name);
                                                    alert(`📁 Save location set to: ${dirHandle.name}`);
                                                } else {
                                                    alert('⚠️ Directory picker not supported. Files will download to default folder.');
                                                }
                                            } catch (error) {
                                                if (error.name !== 'AbortError') {
                                                    console.error('Error selecting directory:', error);
                                                }
                                            }
                                        }}
                                        className="btn-secondary"
                                        style={{ 
                                            width: '100%', 
                                            marginBottom: '8px',
                                            background: selectedDirectory ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)' : 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)',
                                            border: selectedDirectory ? 'none' : '2px solid #ef4444',
                                            animation: selectedDirectory ? 'none' : 'pulse 2s infinite'
                                        }}
                                    >
                                        {selectedDirectory ? `📁 Save to: ${saveDirectoryName}` : '📁 Select Save Directory'}
                                    </button>                                    

                                    <button 
                                        onClick={saveCurrentImageToChosenLocation}
                                        className="btn-primary"
                                        style={{ 
                                            width: '100%', 
                                            marginBottom: '8px',
                                            background: 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)'
                                        }}
                                    >
                                        💾 Save JSON + Annotated Image (Press S)
                                    </button>

                                    {/* Save all annotated images at once */}
                                    {imageDirectory.length > 1 && Object.keys(imageAnnotationsMap).length > 0 && (
                                        <button 
                                            onClick={async () => {
                                                if (!selectedDirectory) {
                                                    alert('⚠️ Please select a save directory first!');
                                                    return;
                                                }
                                                
                                                const annotatedImages = Object.keys(imageAnnotationsMap);
                                                let savedCount = 0;
                                                
                                                for (const filename of annotatedImages) {
                                                    const imageData = imageAnnotationsMap[filename];
                                                    if (imageData.annotations.objects.length > 0) {
                                                        const baseFilename = filename.split('.')[0];
                                                        
                                                        // Save JSON
                                                        const jsonData = {
                                                            ...imageData.annotations,
                                                            export_info: {
                                                                tool: "Advanced Vehicle Dataset Annotation Tool",
                                                                version: "2.0",
                                                                exported_at: new Date().toISOString(),
                                                                schema_version: "AVC-ANPR-v2.0",
                                                                batch_export: true
                                                            }
                                                        };
                                                        
                                                        await saveToSelectedDirectory(jsonData, `${baseFilename}_annotations.json`);
                                                        savedCount++;
                                                    }
                                                }
                                                
                                                console.log(`🎉 Successfully saved ${savedCount} annotated images to ${saveDirectoryName}!`);
                                            }}
                                            className="btn-primary"
                                            style={{ 
                                                width: '100%', 
                                                marginBottom: '8px',
                                                background: 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)'
                                            }}
                                        >
                                            💾 Save All Annotated Images ({Object.keys(imageAnnotationsMap).filter(filename => imageAnnotationsMap[filename].annotations.objects.length > 0).length})
                                        </button>
                                    )}




                                    
                                    <div style={{ fontSize: '10px', color: '#6b7280', marginTop: '8px', fontStyle: 'italic' }}>
                                        💡 Tip: Create "annotated_images" and "JSON" folders to organize your exports!
                                    </div>
                                </div>
                            )}
                        </div>
                        
                        {/* Main Canvas */}
                        <div className="card" style={{ padding: '24px', minHeight: '650px' }}>
                            {!imagePreview ? (
                                <div 
                                    className={`drop-zone ${isDragging ? 'dragover' : ''}`}
                                    onDragOver={handleDragOver}
                                    onDragLeave={handleDragLeave}
                                    onDrop={handleDrop}
                                    onClick={() => fileInputRef.current?.click()}
                                    style={{ height: '100%', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center' }}
                                >
                                    <div style={{ fontSize: '64px', marginBottom: '16px' }}>🖼️</div>
                                    <h3 style={{ fontSize: '24px', color: '#64748b', marginBottom: '8px' }}>
                                        {isDragging ? 'Drop your vehicle images here!' : 'Upload images for annotation'}
                                    </h3>
                                    <p style={{ color: '#94a3b8' }}>Single image or entire folder</p>
                                    <p style={{ color: '#cbd5e1', fontSize: '14px', marginTop: '16px' }}>
                                        Supported formats: JPG, PNG, GIF, WebP
                                    </p>
                                </div>
                            ) : (
                               
                                <div 
                                    ref={containerRef}
                                    className="image-container"
                                    onMouseMove={handleMouseMove}
                                    onMouseLeave={handleMouseLeave}
                                    onWheel={handleWheel}
                                    style={{ 
                                        position: 'relative',
                                        maxWidth: '100%',
                                        maxHeight: '650px',
                                        overflow: 'hidden',
                                        borderRadius: '16px',
                                        boxShadow: '0 10px 25px rgba(0,0,0,0.1)',
                                        cursor: isDrawing ? 'crosshair' : (zoomLevel > 1 ? (isPanning ? 'grabbing' : 'grab') : 'default')

                                    }}
                                    onMouseDown={handleImageMouseDown}
                                >
                                

                                    <img 
                                        ref={imageRef}
                                        key={`normal-${isFullscreen}`}
                                        src={imagePreview} 
                                        alt="Vehicle for annotation" 
                                        className="uploaded-image"
                                        style={{
                                            transform: `scale(${zoomLevel}) translate(${panPosition.x / zoomLevel}px, ${panPosition.y / zoomLevel}px)`,
                                            transition: isPanning ? 'none' : 'transform 0.2s ease',
                                            cursor: isDrawing ? 'crosshair' : (zoomLevel > 1 ? (isPanning ? 'grabbing' : 'grab') : 'default'),
                                            userSelect: 'none',
                                            pointerEvents: 'auto'
                                        }}
                                        draggable={false}
                                    />
                                    


                                    {/* Render existing bounding boxes */}
                                    {annotations.objects.map(obj => {
                                        if (!imageRef.current) return null;
                                        
                                        // Use appropriate container based on mode
                                        const currentContainer = isFullscreen ? fullscreenContainerRef.current : containerRef.current;
                                        if (!currentContainer) return null;
                                        
                                        const bbox = obj.bbox;
                                        const imageRect = imageRef.current.getBoundingClientRect();
                                        const containerRect = currentContainer.getBoundingClientRect();
                                        // Calculate scale factors
                                        const scaleX = imageRect.width / annotations.image.width;
                                        const scaleY = imageRect.height / annotations.image.height;
                                        
                                        // Position relative to container
                                        const left = (imageRect.left - containerRect.left) + (bbox[0] * scaleX);
                                        const top = (imageRect.top - containerRect.top) + (bbox[1] * scaleY);
                                        const width = (bbox[2] - bbox[0]) * scaleX;
                                        const height = (bbox[3] - bbox[1]) * scaleY;
                                        
                                        const hasChildren = annotations.objects.some(child => child.parent_id === obj.id);
                                        const isSelected = selectedAnnotation === obj.id;
                                        const isEditing = editingBoxId === obj.id;
                                        
                                        return (
                                            <div
                                                key={obj.id}
                                                className={`bbox ${obj.type} ${isSelected ? 'selected' : ''} ${isEditing ? 'editing' : ''}`}
                                                onMouseDown={(e) => handleBboxMouseDown(e, obj.id)}
                                                style={{
                                                    left: `${left}px`,
                                                    top: `${top}px`,
                                                    width: `${width}px`,
                                                    height: `${height}px`,
                                                    position: 'absolute',
                                                    zIndex: isSelected ? 1000 : 100 - ((bbox[2] - bbox[0]) * (bbox[3] - bbox[1]) / 10000),

                                                    cursor: 'move',
                                                    pointerEvents: 'auto'
                                                }}
                                            >


                                                
                                                
                                                <div className="bbox-label">
                                                    {getAnnotationIcon(obj.type, obj.wheel_type)} {obj.type === 'vehicle' ? (vehicleForm.category || 'VEHICLE') : obj.type.replace('_', ' ').toUpperCase()}
                                                    {obj.type === 'wheel' && obj.wheel_type && ` (${obj.wheel_type.toUpperCase()})`}
                                                    {obj.type === 'vehicle' && vehicleForm.subcategory && ` (${vehicleForm.subcategory})`}
                                                </div>                                                
                                                                                                                                                
                                                {hasChildren && (
                                                    <div className="connection-indicator">
                                                        {annotations.objects.filter(child => child.parent_id === obj.id).length}
                                                    </div>
                                                )}
                                                
                                                {/* Resize handles - only show for selected bbox */}
                                                {isSelected && (
                                                    <>
                                                        <div className="resize-handle nw" onMouseDown={(e) => handleBboxMouseDown(e, obj.id, 'nw')}></div>
                                                        <div className="resize-handle ne" onMouseDown={(e) => handleBboxMouseDown(e, obj.id, 'ne')}></div>
                                                        <div className="resize-handle sw" onMouseDown={(e) => handleBboxMouseDown(e, obj.id, 'sw')}></div>
                                                        <div className="resize-handle se" onMouseDown={(e) => handleBboxMouseDown(e, obj.id, 'se')}></div>
                                                        <div className="resize-handle n" onMouseDown={(e) => handleBboxMouseDown(e, obj.id, 'n')}></div>
                                                        <div className="resize-handle s" onMouseDown={(e) => handleBboxMouseDown(e, obj.id, 's')}></div>
                                                        <div className="resize-handle w" onMouseDown={(e) => handleBboxMouseDown(e, obj.id, 'w')}></div>
                                                        <div className="resize-handle e" onMouseDown={(e) => handleBboxMouseDown(e, obj.id, 'e')}></div>
                                                    </>
                                                )}
                                            </div>
                                        );
                                    })}                                    

                                    {/* Render current drawing box */}
                                    {currentBox && imageRef.current && (
                                        (() => {
                                            // Use appropriate container based on mode
                                            const currentContainer = isFullscreen ? fullscreenContainerRef.current : containerRef.current;
                                            if (!currentContainer) return null;
                                            
                                            const imageRect = imageRef.current.getBoundingClientRect();
                                            const containerRect = currentContainer.getBoundingClientRect();
                                            const scaleX = imageRect.width / annotations.image.width;
                                            const scaleY = imageRect.height / annotations.image.height;
                                            
                                            const left = (imageRect.left - containerRect.left) + (currentBox.x * scaleX);
                                            const top = (imageRect.top - containerRect.top) + (currentBox.y * scaleY);
                                            const width = currentBox.width * scaleX;
                                            const height = currentBox.height * scaleY;
                                            
                                            return (
                                                <div
                                                    className={`bbox ${annotationType}`}
                                                    style={{
                                                        left: `${left}px`,
                                                        top: `${top}px`,
                                                        width: `${width}px`,
                                                        height: `${height}px`,
                                                        position: 'absolute',
                                                        zIndex: 30
                                                    }}
                                                >

                                                    <div className="bbox-label">
                                                        {getAnnotationIcon(annotationType)} {annotationType === 'vehicle' ? vehicleForm.category || 'VEHICLE' : annotationType.replace('_', ' ').toUpperCase()} [Drawing...]
                                                    </div>                                                    
                                                </div>
                                            );
                                        })()
                                    )}
                                    

                                    
                                    {/* Image info overlay */}
                                    <div style={{ 
                                        position: 'absolute', 
                                        top: '16px', 
                                        right: '16px', 
                                        background: 'rgba(0,0,0,0.7)', 
                                        color: 'white', 
                                        padding: '8px 12px', 
                                        borderRadius: '8px', 
                                        fontSize: '12px' 
                                    }}>
                                        {annotations.image.width} × {annotations.image.height}px
                                    </div>

                                    {/* Navigation arrows */}
                                    {imageDirectory.length > 1 && (
                                        <>
                                            <button 
                                                onClick={() => navigateToImage('prev')}
                                                style={{ 
                                                    position: 'absolute', 
                                                    left: '16px', 
                                                    top: '50%', 
                                                    transform: 'translateY(-50%)',
                                                    background: 'rgba(0,0,0,0.8)', 
                                                    color: 'white', 
                                                    border: 'none', 
                                                    width: '50px',
                                                    height: '50px',
                                                    borderRadius: '50%', 
                                                    cursor: 'pointer',
                                                    fontSize: '20px',
                                                    fontWeight: 'bold',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center',
                                                    zIndex: 100
                                                }}
                                                title="Previous image"
                                            >
                                                ←
                                            </button>
                                            
                                            <button 
                                                onClick={() => navigateToImage('next')}
                                                style={{ 
                                                    position: 'absolute', 
                                                    right: '16px', 
                                                    top: '50%', 
                                                    transform: 'translateY(-50%)',
                                                    background: 'rgba(0,0,0,0.8)', 
                                                    color: 'white', 
                                                    border: 'none', 
                                                    width: '50px',
                                                    height: '50px',
                                                    borderRadius: '50%', 
                                                    cursor: 'pointer',
                                                    fontSize: '20px',
                                                    fontWeight: 'bold',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center',
                                                    zIndex: 100
                                                }}
                                                title="Next image"
                                            >
                                                →
                                            </button>
                                            
                                            {/* Image counter */}
                                            <div style={{ 
                                                position: 'absolute', 
                                                bottom: '80px', 
                                                left: '50%', 
                                                transform: 'translateX(-50%)',
                                                background: 'rgba(0,0,0,0.8)', 
                                                color: 'white', 
                                                padding: '8px 16px', 
                                                borderRadius: '20px', 
                                                fontSize: '14px',
                                                fontWeight: 'bold',
                                                zIndex: 100
                                            }}>
                                                {currentImageIndex + 1} / {imageDirectory.length}
                                            </div>
                                        </>
                                    )}                                    
                                    
                                    {/* Remove button */}
                                    <button 
                                        onClick={() => {
                                            setImage(null);
                                            setImagePreview(null);
                                            setIsDrawing(false);
                                            setCurrentBox(null);
                                            setSelectedAnnotation(null);
                                            setAnnotations(prev => ({
                                                ...prev,
                                                image: { filename: "", width: 1920, height: 1080, timestamp: new Date().toISOString() },
                                                objects: []
                                            }));
                                            // Reset file input to allow re-uploading the same file
                                            if (fileInputRef.current) {
                                                fileInputRef.current.value = '';
                                            }
                                        }}
                                    


                                        style={{ 
                                            position: 'absolute', 
                                            top: '16px', 
                                            left: '16px', 
                                            background: 'rgba(255,0,0,0.8)', 
                                            color: 'white', 
                                            border: 'none', 
                                            padding: '8px 12px', 
                                            borderRadius: '8px', 
                                            cursor: 'pointer',
                                            fontSize: '12px',
                                            fontWeight: 'bold'
                                        }}
                                    >
                                        ✕ Remove Image
                                    </button>
                                    

                                    {/* Magnifier indicator */}
                                    {/* Zoom controls */}
                                    <div style={{
                                        position: 'absolute',
                                        bottom: '16px',
                                        left: '16px',
                                        display: 'flex',
                                        gap: '8px',
                                        background: 'rgba(0,0,0,0.8)',
                                        padding: '8px',
                                        borderRadius: '12px'
                                    }}>
                                        <button 
                                            onClick={handleZoomOut} 
                                            style={{
                                                background: 'rgba(255,255,255,0.2)',
                                                border: 'none',
                                                color: 'white',
                                                width: '36px',
                                                height: '36px',
                                                borderRadius: '8px',
                                                cursor: 'pointer',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                fontWeight: 'bold'
                                            }}
                                            title="Zoom Out"
                                        >
                                            −
                                        </button>
                                        <div style={{
                                            color: 'white',
                                            fontSize: '12px',
                                            fontWeight: 'bold',
                                            display: 'flex',
                                            alignItems: 'center',
                                            padding: '0 8px',
                                            minWidth: '50px',
                                            textAlign: 'center'
                                        }}>
                                            {Math.round(zoomLevel * 100)}%
                                        </div>
                                        <button 
                                            onClick={handleZoomIn}
                                            style={{
                                                background: 'rgba(255,255,255,0.2)',
                                                border: 'none',
                                                color: 'white',
                                                width: '36px',
                                                height: '36px',
                                                borderRadius: '8px',
                                                cursor: 'pointer',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                fontWeight: 'bold'
                                            }}
                                            title="Zoom In"
                                        >
                                            +
                                        </button>
                                        <button 
                                            onClick={handleZoomReset}
                                            style={{
                                                background: 'rgba(255,255,255,0.2)',
                                                border: 'none',
                                                color: 'white',
                                                width: '36px',
                                                height: '36px',
                                                borderRadius: '8px',
                                                cursor: 'pointer',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                fontWeight: 'bold'
                                            }}
                                            title="Reset Zoom"
                                        >
                                            ⌂
                                        </button>
                                        <button 
                                            onClick={() => setMagnifierEnabled(!magnifierEnabled)}
                                            style={{
                                                background: magnifierEnabled ? 'rgba(255,215,0,0.8)' : 'rgba(255,255,255,0.2)',
                                                border: 'none',
                                                color: 'white',
                                                width: '36px',
                                                height: '36px',
                                                borderRadius: '8px',
                                                cursor: 'pointer',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                fontWeight: 'bold'
                                            }}
                                            title={magnifierEnabled ? "Disable Magnifier" : "Enable Magnifier"}
                                        >
                                            🔍
                                        </button>

                                        <button 
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                e.preventDefault();
                                                setIsFullscreen(true);
                                            }}
                                            style={{
                                                background: 'rgba(59, 130, 246, 0.8)',
                                                border: 'none',
                                                color: 'white',
                                                width: '36px',
                                                height: '36px',
                                                borderRadius: '8px',
                                                cursor: 'pointer',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                fontWeight: 'bold',
                                                zIndex: 1000
                                            }}
                                            title="Fullscreen Mode (or press F)"
                                        >
                                            ⛶
                                        </button>                                       
                                    </div>


                                    {/* Magnifier */}
                                    {showMagnifier && magnifierEnabled && ( 
                                        <div
                                            style={{
                                                position: 'fixed',
                                                left: `${magnifierPosition.x}px`,
                                                top: `${magnifierPosition.y}px`,
                                                width: `${magnifierSize}px`,
                                                height: `${magnifierSize}px`,
                                                border: '3px solid #fff',
                                                borderRadius: '50%',
                                                boxShadow: '0 0 20px rgba(0,0,0,0.5)',
                                                backgroundImage: `url(${imagePreview})`,
                                                backgroundRepeat: 'no-repeat',
                                                backgroundSize: `${annotations.image.width * magnificationLevel}px ${annotations.image.height * magnificationLevel}px`,
                                                backgroundPosition: `-${magnifierImagePosition.x * magnificationLevel - magnifierSize/2}px -${magnifierImagePosition.y * magnificationLevel - magnifierSize/2}px`,
                                                pointerEvents: 'none',
                                                zIndex: 1000
                                            }}
                                        />
                                    )}                                     
                                    
                                </div>
                            )}
                        </div>
                        
                       
                        {/* Right Panel - Vehicle Information Forms */}
                        <div className="card" style={{ padding: '24px' }}>
                            <div className="scrollable-panel">
                                <h2 style={{ fontSize: '20px', fontWeight: 'bold', marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                                    ⚙️ Vehicle Properties
                                </h2>
                                

                                
                                {/* Tabs for different sections */}
                                <div className="tabs">
                                    <button 
                                        className={`tab ${activeTab === 'basic' ? 'active' : ''}`}
                                        onClick={() => setActiveTab('basic')}
                                    >
                                        Basic
                                    </button>
                                    <button 
                                        className={`tab ${activeTab === 'mechanical' ? 'active' : ''}`}
                                        onClick={() => setActiveTab('mechanical')}
                                    >
                                        Mechanical
                                    </button>
                                    <button 
                                        className={`tab ${activeTab === 'attributes' ? 'active' : ''}`}
                                        onClick={() => setActiveTab('attributes')}
                                    >
                                        Attributes
                                    </button>
                                </div>
                                
                                {/* Basic Information Tab */}
                                {activeTab === 'basic' && (
                                    <div>
                                        <div className="form-row">
                                            <div className="form-group">
                                                <label className="form-label">Category</label>
                                                <select 
                                                    className="input-field input-small"
                                                    value={vehicleForm.category}
                                                    onChange={(e) => setVehicleForm(prev => ({ 
                                                        ...prev, 
                                                        category: e.target.value,
                                                        subcategory: '' // Reset subcategory when category changes
                                                    }))}
                                                >
                                                    {Object.keys(vehicleCategories).map(cat => (
                                                        <option key={cat} value={cat}>{cat}</option>
                                                    ))}
                                                </select>
                                            </div>
                                            <div className="form-group">
                                                <label className="form-label">Subcategory</label>
                                                <select 
                                                    className="input-field input-small"
                                                    value={vehicleForm.subcategory}
                                                    onChange={(e) => setVehicleForm(prev => ({ ...prev, subcategory: e.target.value }))}
                                                >
                                                    <option value="">Select...</option>
                                                    {vehicleCategories[vehicleForm.category]?.map(subcat => (
                                                        <option key={subcat} value={subcat}>{subcat}</option>
                                                    ))}
                                                </select>
                                            </div>
                                        </div>
                                        

                                        <div className="form-row">
                                            <div className="form-group">
                                                <label className="form-label">Brand</label>
                                                <input 
                                                    className="input-field input-small"
                                                    placeholder="e.g. Volvo, Mercedes"
                                                    value={vehicleForm.brand}
                                                    onChange={(e) => setVehicleForm(prev => ({ ...prev, brand: e.target.value }))}
                                                />
                                            </div>
                                            <div className="form-group">
                                                <label className="form-label">Color</label>
                                                <select 
                                                    className="input-field input-small"
                                                    value={vehicleForm.color}
                                                    onChange={(e) => setVehicleForm(prev => ({ ...prev, color: e.target.value }))}
                                                >
                                                    <option value="">Select color...</option>
                                                    {colors.map(color => (
                                                        <option key={color} value={color}>{color}</option>
                                                    ))}
                                                </select>
                                            </div>
                                        </div>                                        

                                        
                                        
                                        <div className="form-row">
                                            <div className="form-group">
                                                <label className="form-label">View Pose</label>
                                                <select 
                                                    className="input-field input-small"
                                                    value={vehicleForm.view_pose}
                                                    onChange={(e) => setVehicleForm(prev => ({ ...prev, view_pose: e.target.value }))}
                                                >
                                                    {viewPoses.map(pose => (
                                                        <option key={pose} value={pose}>{pose.replace('_', ' ')}</option>
                                                    ))}
                                                </select>
                                            </div>
                                            <div className="form-group">
                                                <label className="form-label">Direction</label>
                                                <select 
                                                    className="input-field input-small"
                                                    value={vehicleForm.direction}
                                                    onChange={(e) => setVehicleForm(prev => ({ ...prev, direction: e.target.value }))}
                                                >
                                                    {directions.map(dir => (
                                                        <option key={dir} value={dir}>{dir.replace('_', ' ')}</option>
                                                    ))}
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <div className="form-row">
                                            <div className="form-group">
                                                <label className="form-label">Operator/Company</label>
                                                <input 
                                                    className="input-field input-small"
                                                    placeholder="e.g. DHL, FedEx"
                                                    value={vehicleForm.operator}
                                                    onChange={(e) => setVehicleForm(prev => ({ ...prev, operator: e.target.value }))}
                                                />
                                            </div>
                                            <div className="form-group">
                                                <label className="form-label">Seats</label>
                                                <input 
                                                    type="number"
                                                    className="input-field input-small"
                                                    min="1"
                                                    value={vehicleForm.number_of_seats}
                                                    onChange={(e) => setVehicleForm(prev => ({ ...prev, number_of_seats: parseInt(e.target.value) }))}
                                                />
                                            </div>
                                        </div>
                                        

                                        <div className="section-header" style={{ marginTop: '20px' }}>
                                            🔢 License Plate Information
                                        </div>

                                        {/* Move checkboxes to the top */}
                                        <div className="checkbox-grid">
                                            <label className="checkbox-item">
                                                <input 
                                                    type="checkbox" 
                                                    checked={vehicleForm.license_plate_visible}
                                                    onChange={(e) => {
                                                        if (e.target.checked) {
                                                            setVehicleForm(prev => ({ 
                                                                ...prev, 
                                                                license_plate_visible: true,
                                                                license_plate_blurred: false // Uncheck blurred when visible is checked
                                                            }));
                                                        } else {
                                                            setVehicleForm(prev => ({ 
                                                                ...prev, 
                                                                license_plate_visible: false,
                                                                license_plate_text: '' // Clear text when not visible
                                                            }));
                                                        }
                                                    }}
                                                />
                                                Visible
                                            </label>
                                            <label className="checkbox-item">
                                                <input 
                                                    type="checkbox" 
                                                    checked={vehicleForm.license_plate_blurred}
                                                    onChange={(e) => {
                                                        if (e.target.checked) {
                                                            setVehicleForm(prev => ({ 
                                                                ...prev, 
                                                                license_plate_blurred: true,
                                                                license_plate_visible: false, // Uncheck visible when blurred is checked
                                                                license_plate_text: '' // Clear text when blurred
                                                            }));
                                                        } else {
                                                            setVehicleForm(prev => ({ 
                                                                ...prev, 
                                                                license_plate_blurred: false
                                                            }));
                                                        }
                                                    }}
                                                />
                                                Blurred
                                            </label>
                                        </div>

                                        <div className="form-group">
                                            <label className="form-label">License Plate Text</label>
                                            <input 
                                                className="input-field input-small"
                                                placeholder={vehicleForm.license_plate_blurred ? "Text unavailable (blurred)" : vehicleForm.license_plate_visible ? "e.g. WXD1023" : "Not visible"}
                                                value={vehicleForm.license_plate_text}
                                                disabled={vehicleForm.license_plate_blurred || !vehicleForm.license_plate_visible} // Disable if blurred OR not visible
                                                onChange={(e) => setVehicleForm(prev => ({ ...prev, license_plate_text: e.target.value.toUpperCase() }))}
                                                style={{
                                                    backgroundColor: vehicleForm.license_plate_blurred || !vehicleForm.license_plate_visible ? '#f5f5f5' : 'white',
                                                    color: vehicleForm.license_plate_blurred || !vehicleForm.license_plate_visible ? '#999' : 'black'
                                                }}
                                            />
                                        </div>

                                        <div className="form-row">
                                            <div className="form-group">
                                                <label className="form-label">Plate Country</label>
                                                <input 
                                                    className="input-field input-small"
                                                    value={vehicleForm.license_plate_country}
                                                    disabled={!vehicleForm.license_plate_visible} // Disable if not visible
                                                    onChange={(e) => setVehicleForm(prev => ({ ...prev, license_plate_country: e.target.value }))}
                                                    style={{
                                                        backgroundColor: !vehicleForm.license_plate_visible ? '#f5f5f5' : 'white',
                                                        color: !vehicleForm.license_plate_visible ? '#999' : 'black'
                                                    }}
                                                />
                                            </div>
                                            <div className="form-group">
                                                <label className="form-label">Plate Format</label>
                                                <select 
                                                    className="input-field input-small"
                                                    value={vehicleForm.license_plate_format}
                                                    disabled={!vehicleForm.license_plate_visible} // Disable if not visible
                                                    onChange={(e) => setVehicleForm(prev => ({ ...prev, license_plate_format: e.target.value }))}
                                                    style={{
                                                        backgroundColor: !vehicleForm.license_plate_visible ? '#f5f5f5' : 'white',
                                                        color: !vehicleForm.license_plate_visible ? '#999' : 'black'
                                                    }}
                                                >
                                                    <option value="standard">Standard</option>
                                                    <option value="commercial">Commercial</option>
                                                    <option value="government">Government</option>
                                                    <option value="diplomatic">Diplomatic</option>
                                                    <option value="temporary">Temporary</option>
                                                </select>
                                            </div>
                                        </div>                                        


                                    </div>
                                )}
                                
                                {/* Mechanical Tab */}
                                {activeTab === 'mechanical' && (
                                    <div>
                                        <div className="section-header">
                                            ⚙️ Mechanical Properties
                                        </div>
                                        
                                        <div className="form-row">
                                            <div className="form-group">
                                                <label className="form-label">Visible Wheels</label>
                                                <input 
                                                    type="number"
                                                    className="input-field input-small"
                                                    min="0"
                                                    value={vehicleForm.number_of_wheels_visible}
                                                    onChange={(e) => setVehicleForm(prev => ({ ...prev, number_of_wheels_visible: parseInt(e.target.value) }))}
                                                />
                                            </div>
                                            <div className="form-group">
                                                <label className="form-label">Inferred Axles</label>
                                                <input 
                                                    type="number"
                                                    className="input-field input-small"
                                                    min="0"
                                                    value={vehicleForm.number_of_axles_inferred}
                                                    onChange={(e) => setVehicleForm(prev => ({ ...prev, number_of_axles_inferred: parseInt(e.target.value) }))}
                                                />
                                            </div>
                                        </div>
                                        
                                        <div className="form-group">
                                            <label className="form-label">Raised Axles</label>
                                            <input 
                                                type="number"
                                                className="input-field input-small"
                                                min="0"
                                                value={vehicleForm.number_of_axles_raised}
                                                onChange={(e) => setVehicleForm(prev => ({ ...prev, number_of_axles_raised: parseInt(e.target.value) }))}
                                            />
                                        </div>
                                        
                                        <div className="checkbox-grid">
                                            <label className="checkbox-item">
                                                <input 
                                                    type="checkbox" 
                                                    checked={vehicleForm.truck_trailer_labels_visible}
                                                    onChange={(e) => setVehicleForm(prev => ({ ...prev, truck_trailer_labels_visible: e.target.checked }))}
                                                />
                                                Trailer Labels Visible
                                            </label>
                                            <label className="checkbox-item">
                                                <input 
                                                    type="checkbox" 
                                                    checked={vehicleForm.cargo_present}
                                                    onChange={(e) => setVehicleForm(prev => ({ ...prev, cargo_present: e.target.checked }))}
                                                />
                                                Cargo Present
                                            </label>
                                        </div>
                                    </div>
                                )}
                                
                                {/* Attributes Tab */}
                                {activeTab === 'attributes' && (
                                    <div>
                                        <div className="section-header">
                                            🏷️ Vehicle Attributes
                                        </div>
                                        
                                        <div className="checkbox-grid">
                                            <label className="checkbox-item">
                                                <input 
                                                    type="checkbox" 
                                                    checked={vehicleForm.is_taxi}
                                                    onChange={(e) => setVehicleForm(prev => ({ ...prev, is_taxi: e.target.checked }))}
                                                />
                                                🚕 Taxi
                                            </label>
                                            <label className="checkbox-item">
                                                <input 
                                                    type="checkbox" 
                                                    checked={vehicleForm.is_bus}
                                                    onChange={(e) => setVehicleForm(prev => ({ ...prev, is_bus: e.target.checked }))}
                                                />
                                                🚌 Bus
                                            </label>
                                            <label className="checkbox-item">
                                                <input 
                                                    type="checkbox" 
                                                    checked={vehicleForm.is_emergency_vehicle}
                                                    onChange={(e) => setVehicleForm(prev => ({ ...prev, is_emergency_vehicle: e.target.checked }))}
                                                />
                                                🚨 Emergency
                                            </label>
                                            <label className="checkbox-item">
                                                <input 
                                                    type="checkbox" 
                                                    checked={vehicleForm.is_electric}
                                                    onChange={(e) => setVehicleForm(prev => ({ ...prev, is_electric: e.target.checked }))}
                                                />
                                                ⚡ Electric
                                            </label>
                                        </div>
                                        
                                        {vehicleForm.is_bus && (
                                            <div className="form-group">
                                                <label className="form-label">Bus Type</label>
                                                <select 
                                                    className="input-field input-small"
                                                    value={vehicleForm.bus_type}
                                                    onChange={(e) => setVehicleForm(prev => ({ ...prev, bus_type: e.target.value }))}
                                                >
                                                    <option value="">Select bus type...</option>
                                                    <option value="city">City Bus</option>
                                                    <option value="school">School Bus</option>
                                                    <option value="tour">Tour Bus</option>
                                                    <option value="double_decker">Double Decker</option>
                                                    <option value="shuttle">Shuttle</option>
                                                </select>
                                            </div>
                                        )}
                                    </div>
                                )}
                                
                                <button 
                                    className="btn-secondary"
                                    style={{ 
                                        width: '100%', 
                                        marginBottom: '8px',
                                        background: selectedAnnotation ? 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)' : 'linear-gradient(135deg, #94a3b8 0%, #64748b 100%)',
                                        opacity: selectedAnnotation ? 1 : 0.5
                                    }}
                                    onClick={updateSelectedAnnotationWithForm}
                                    disabled={!selectedAnnotation} // Only disable if no annotation is selected
                                >
                                    📝 Update Selected Annotation {selectedAnnotation ? '✅' : '❌'}
                                </button>



                                {/* Quick Actions */}
                                <div style={{ marginTop: '24px', paddingTop: '16px', borderTop: '2px solid #e5e7eb' }}>
                                    <div className="section-header">
                                        ⚡ Quick Actions
                                    </div>
                                    
                                    <button 
                                        className="btn-secondary"
                                        style={{ width: '100%', marginBottom: '8px' }}
                                        onClick={() => {
                                            setVehicleForm({
                                                category: 'Light Vehicle',
                                                subcategory: 'Sedan',
                                                country: 'MY',
                                                brand: '',
                                                model: '',
                                                color: '',
                                                operator: '',
                                                number_of_seats: 4,
                                                view_pose: 'rear',
                                                direction: 'northbound',
                                                number_of_wheels_visible: 4,
                                                number_of_axles_inferred: 2,
                                                number_of_axles_raised: 0,
                                                truck_trailer_labels_visible: false,
                                                cargo_present: false,
                                                is_taxi: false,
                                                is_bus: false,
                                                bus_type: '',
                                                is_emergency_vehicle: false,
                                                is_electric: false,
                                                license_plate_text: '',
                                                license_plate_country: 'MY',
                                                license_plate_format: 'standard',
                                                license_plate_blurred: false,
                                                license_plate_visible: true
                                            });
                                        }}
                                    >
                                        🔄 Reset Form
                                    </button>

                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px', marginBottom: '8px' }}>
                                        <button 
                                            className="btn-secondary"
                                            onClick={undo}
                                            disabled={undoHistory.length === 0}
                                            style={{ 
                                                background: undoHistory.length === 0 ? 'linear-gradient(135deg, #94a3b8 0%, #64748b 100%)' : 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)',
                                                opacity: undoHistory.length === 0 ? 0.5 : 1
                                            }}
                                            title="Undo (Ctrl+Z)"
                                        >
                                            ↶ Undo
                                        </button>
                                        
                                        <button 
                                            className="btn-secondary"
                                            onClick={redo}
                                            disabled={redoHistory.length === 0}
                                            style={{ 
                                                background: redoHistory.length === 0 ? 'linear-gradient(135deg, #94a3b8 0%, #64748b 100%)' : 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)',
                                                opacity: redoHistory.length === 0 ? 0.5 : 1
                                            }}
                                            title="Redo (Ctrl+Y)"
                                        >
                                            ↷ Redo
                                        </button>
                                    </div>                                    
                                    
                                    <button 
                                        className="btn-secondary"
                                        style={{ width: '100%', marginBottom: '8px' }}
                                        onClick={() => {
                                            setVehicleForm(prev => ({
                                                ...prev,
                                                category: 'Heavy Vehicle',
                                                subcategory: 'Prime Mover',
                                                number_of_wheels_visible: 10,
                                                number_of_axles_inferred: 5,
                                                truck_trailer_labels_visible: true,
                                                cargo_present: true
                                            }));
                                        }}
                                    >
                                        🚛 Heavy Vehicle Preset
                                    </button>
                                    
                                    <button 
                                        className="btn-secondary"
                                        style={{ width: '100%' }}
                                        onClick={() => {
                                            setVehicleForm(prev => ({
                                                ...prev,
                                                category: 'Bus',
                                                subcategory: 'City Bus',
                                                is_bus: true,
                                                bus_type: 'city',
                                                number_of_wheels_visible: 6,
                                                number_of_axles_inferred: 3
                                            }));
                                        }}
                                    >
                                        🚌 Bus Preset
                                    </button>
                                </div>
                                
                                {/* Selected Annotation Info */}
                                {selectedAnnotation && (
                                    <div style={{ marginTop: '20px' }}>
                                        <div className="section-header">
                                            📝 Selected Annotation
                                        </div>
                                        {(() => {
                                            const selected = annotations.objects.find(obj => obj.id === selectedAnnotation);
                                            if (!selected) return null;
                                            
                                            return (
                                                <div style={{ 
                                                    padding: '12px', 
                                                    background: '#fff3cd', 
                                                    border: '2px solid #ffc107', 
                                                    borderRadius: '8px',
                                                    fontSize: '12px'
                                                }}>
                                                    <div style={{ fontWeight: 'bold', marginBottom: '8px' }}>
                                                        {getAnnotationIcon(selected.type, selected.wheel_type)} {selected.type.replace('_', ' ').toUpperCase()}

                                                    </div>
                                                    
                                                    <div style={{ 
                                                        marginTop: '8px', 
                                                        padding: '8px', 
                                                        background: 'rgba(255,0,0,0.1)', 
                                                        borderRadius: '4px', 
                                                        fontSize: '11px',
                                                        color: '#dc3545',
                                                        fontWeight: 'bold'
                                                    }}>
                                                        💡 Press DELETE or BACKSPACE to remove this annotation
                                                    </div>
                                                    
                                                    {/* Type Selector - ADD THIS INSIDE THE RETURN BLOCK */}
                                                    <div style={{ marginTop: '12px' }}>
                                                        <label className="form-label">Change Annotation Type</label>
                                                        <select 
                                                            className="input-field input-small"
                                                            value={selected.type}
                                                            onChange={(e) => {
                                                                const newType = e.target.value;
                                                                saveToHistory(annotations);
                                                                setAnnotations(prev => ({
                                                                    ...prev,
                                                                    objects: prev.objects.map(obj => 
                                                                        obj.id === selectedAnnotation 
                                                                            ? { ...obj, type: newType }
                                                                            : obj
                                                                    )
                                                                }));
                                                            }}
                                                        >
                                                            <option value="vehicle">🚗 Vehicle</option>
                                                            <option value="license_plate">🔢 License Plate</option>
                                                            <option value="wheel">⚙️ Wheel</option>
                                                            <option value="attachment">🚛 Attachment/Trailer</option>
                                                        </select>
                                                        
                                                        <div style={{ marginTop: '8px' }}>
                                                            <div style={{ fontSize: '11px', fontWeight: 'bold', marginBottom: '6px', color: '#374151' }}>
                                                                Quick Change:
                                                            </div>
                                                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '4px' }}>
                                                                <button 
                                                                    className="btn-secondary"
                                                                    style={{ 
                                                                        fontSize: '9px', 
                                                                        padding: '4px 6px',
                                                                        background: 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)'
                                                                    }}
                                                                    onClick={() => {
                                                                        saveToHistory(annotations);
                                                                        setAnnotations(prev => ({
                                                                            ...prev,
                                                                            objects: prev.objects.map(obj => 
                                                                                obj.id === selectedAnnotation 
                                                                                    ? { ...obj, type: 'vehicle' }
                                                                                    : obj
                                                                            )
                                                                        }));
                                                                    }}
                                                                >
                                                                    🚗 Vehicle
                                                                </button>
                                                                <button 
                                                                    className="btn-secondary"
                                                                    style={{ 
                                                                        fontSize: '9px', 
                                                                        padding: '4px 6px',
                                                                        background: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)'
                                                                    }}
                                                                    onClick={() => {
                                                                        saveToHistory(annotations);
                                                                        setAnnotations(prev => ({
                                                                            ...prev,
                                                                            objects: prev.objects.map(obj => 
                                                                                obj.id === selectedAnnotation 
                                                                                    ? { ...obj, type: 'license_plate' }
                                                                                    : obj
                                                                            )
                                                                        }));
                                                                    }}
                                                                >
                                                                    🔢 Plate
                                                                </button>
                                                                <button 
                                                                    className="btn-secondary"
                                                                    style={{ 
                                                                        fontSize: '9px', 
                                                                        padding: '4px 6px',
                                                                        background: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)'
                                                                    }}
                                                                    onClick={() => {
                                                                        saveToHistory(annotations);
                                                                        setAnnotations(prev => ({
                                                                            ...prev,
                                                                            objects: prev.objects.map(obj => 
                                                                                obj.id === selectedAnnotation 
                                                                                    ? { ...obj, type: 'wheel' }
                                                                                    : obj
                                                                            )
                                                                        }));
                                                                    }}
                                                                >
                                                                    ⚙️ Wheel
                                                                </button>
                                                                <button 
                                                                    className="btn-secondary"
                                                                    style={{ 
                                                                        fontSize: '9px', 
                                                                        padding: '4px 6px',
                                                                        background: 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)'
                                                                    }}
                                                                    onClick={() => {
                                                                        saveToHistory(annotations);
                                                                        setAnnotations(prev => ({
                                                                            ...prev,
                                                                            objects: prev.objects.map(obj => 
                                                                                obj.id === selectedAnnotation 
                                                                                    ? { ...obj, type: 'attachment' }
                                                                                    : obj
                                                                            )
                                                                        }));
                                                                    }}
                                                                >
                                                                    🚛 Attachment
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })()}
                                    </div>
                                )}



                                
                                {/* JSON Preview */}
                                {annotations.objects.length > 0 && (
                                    <div style={{ marginTop: '20px' }}>
                                        <div className="section-header">
                                            📄 JSON Preview
                                        </div>
                                        <div style={{ 
                                            background: '#f8f9fa', 
                                            border: '1px solid #e9ecef', 
                                            borderRadius: '8px',
                                            padding: '12px',
                                            fontSize: '10px',
                                            fontFamily: 'monospace',
                                            maxHeight: '200px',
                                            overflowY: 'auto'
                                        }}>
                                            <pre style={{ margin: 0, whiteSpace: 'pre-wrap' }}>
                                                {JSON.stringify({
                                                    image: annotations.image,
                                                    objects: annotations.objects.slice(0, 1) // Show first object as preview
                                                }, null, 2)}
                                                {annotations.objects.length > 1 && `\n... and ${annotations.objects.length - 1} more objects`}
                                            </pre>
                                        </div>
                                    </div>
                                )}
                                {/* Keyboard Shortcuts Help */}
                                <div style={{ marginTop: '20px' }}>
                                    <div className="section-header">
                                        ⌨️ Keyboard Shortcuts
                                    </div>
                                    <div style={{ 
                                        background: '#f8f9fa', 
                                        border: '1px solid #e9ecef', 
                                        borderRadius: '8px',
                                        padding: '12px',
                                        fontSize: '11px'
                                    }}>
                                        <div style={{ marginBottom: '4px' }}><strong>Ctrl+Z:</strong> Undo last action</div>
                                        <div style={{ marginBottom: '4px' }}><strong>Ctrl+Y:</strong> Redo action</div>
                                        <div style={{ marginBottom: '4px' }}><strong>Delete/Backspace:</strong> Remove selected annotation</div>
                                        <div style={{ marginBottom: '4px' }}><strong>1,2,3,4,5:</strong> Change selected annotation type</div>
                                        <div style={{ marginBottom: '4px' }}><strong>S:</strong> Save JSON + Annotated Image</div>
                                        <div style={{ marginBottom: '4px' }}><strong>W:</strong> Toggle drawing mode</div>
                                        <div style={{ marginBottom: '4px' }}><strong>F:</strong> Enter fullscreen mode</div>
                                        <div><strong>Escape:</strong> Exit fullscreen, cancel drawing, or deselect</div>
                                        <div style={{ marginBottom: '4px' }}><strong>Ctrl+Shift+S:</strong> Save all annotated images</div>
                                        <div style={{ marginBottom: '4px' }}><strong>← →:</strong> Navigate images (in fullscreen)</div>

                                    </div>
                                   
                                </div>  
                                                              
                            </div>
                        </div>
                        {/* Fullscreen Modal */}
                        {isFullscreen && imagePreview && (
                            <div className="fullscreen-overlay" onClick={() => setIsFullscreen(false)}>
                                <div className="fullscreen-container" onClick={(e) => e.stopPropagation()}>
                                    {/* Fullscreen Toolbar */}
                                    <div className="fullscreen-toolbar">
                                        <button 
                                            className={`fullscreen-btn ${isDrawing ? 'active' : ''}`}
                                            onClick={() => setIsDrawing(!isDrawing)}
                                        >
                                            {isDrawing ? '🎯 Drawing ON' : '✏️ Start Drawing'}
                                        </button>
                                        
                                        <select 
                                            value={annotationType}
                                            onChange={(e) => setAnnotationType(e.target.value)}
                                            className="fullscreen-btn"
                                            style={{
                                                background: 'rgba(255, 255, 255, 0.2)',
                                                border: 'none',
                                                color: 'white',
                                                padding: '8px 12px',
                                                borderRadius: '6px',
                                                fontSize: '12px'
                                            }}
                                        >
                                            <option value="vehicle" style={{ color: 'black' }}>🚗 Vehicle</option>
                                            <option value="license_plate" style={{ color: 'black' }}>🔢 License Plate</option>
                                            <option value="wheel" style={{ color: 'black' }}>⚙️ Wheel</option>
                                            <option value="attachment" style={{ color: 'black' }}>🚛 Attachment</option>
                                        </select>
                                        
                                        {annotationType === 'wheel' && (
                                            <select 
                                                value={wheelType}
                                                onChange={(e) => setWheelType(e.target.value)}
                                                className="fullscreen-btn"
                                                style={{
                                                    background: 'rgba(255, 255, 255, 0.2)',
                                                    border: 'none',
                                                    color: 'white',
                                                    padding: '8px 12px',
                                                    borderRadius: '6px',
                                                    fontSize: '12px'
                                                }}
                                            >
                                                <option value="single" style={{ color: 'black' }}>🔘 Single</option>
                                                <option value="double" style={{ color: 'black' }}>⚫⚫ Double</option>
                                            </select>
                                        )}
                                        
                                        <button 
                                            className={`fullscreen-btn ${magnifierEnabled ? 'active' : ''}`}
                                            onClick={() => setMagnifierEnabled(!magnifierEnabled)}
                                            style={{ 
                                                background: magnifierEnabled ? 'rgba(255, 215, 0, 0.8)' : 'rgba(255, 255, 255, 0.2)' 
                                            }}
                                        >
                                            🔍 {magnifierEnabled ? 'Disable' : 'Enable'} Magnifier
                                        </button>

                                        
                                        <button 
                                            className="fullscreen-btn"
                                            onClick={() => setIsFullscreen(false)}
                                            style={{ background: 'rgba(255, 0, 0, 0.8)' }}
                                        >
                                            ✕ Exit Fullscreen
                                        </button>
                                    </div>
                                    
                                    {/* Fullscreen Image Container */}
                                    <div 
                                        ref={fullscreenContainerRef}
                                        style={{ 
                                            position: 'relative',
                                            width: '100%',
                                            height: '100%',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            cursor: isDrawing ? 'crosshair' : 'default',
                                            overflow: 'hidden'
                                        }}
                                        onMouseDown={handleImageMouseDown}
                                        onMouseMove={handleMouseMove}
                                        onMouseLeave={handleMouseLeave}
                                        onWheel={handleWheel}
                                    >
                                        <img 
                                            ref={imageRef}
                                            key={`fullscreen-${isFullscreen}`}
                                            src={imagePreview} 
                                            alt="Vehicle for annotation"
                                            style={{
                                                maxWidth: '100%',
                                                maxHeight: '100%',
                                                objectFit: 'contain',
                                                transform: `scale(${zoomLevel}) translate(${panPosition.x / zoomLevel}px, ${panPosition.y / zoomLevel}px)`,
                                                transition: isPanning ? 'none' : 'transform 0.2s ease',
                                                cursor: isDrawing ? 'crosshair' : (zoomLevel > 1 ? (isPanning ? 'grabbing' : 'grab') : 'default'),
                                                userSelect: 'none'
                                            }}
                                            draggable={false}
                                        />
                                        
                                        {/* Render existing bounding boxes in fullscreen */}
                                        {annotations.objects.map(obj => {
                                            if (!imageRef.current || !fullscreenContainerRef.current) return null;

                                            
                                            const bbox = obj.bbox;
                                            const imageRect = imageRef.current.getBoundingClientRect();
                                            const containerRect = fullscreenContainerRef.current.getBoundingClientRect();
                                            
                                            const scaleX = imageRect.width / annotations.image.width;
                                            const scaleY = imageRect.height / annotations.image.height;
                                            
                                            const left = (imageRect.left - containerRect.left) + (bbox[0] * scaleX);
                                            const top = (imageRect.top - containerRect.top) + (bbox[1] * scaleY);
                                            const width = (bbox[2] - bbox[0]) * scaleX;
                                            const height = (bbox[3] - bbox[1]) * scaleY;
                                            
                                            const hasChildren = annotations.objects.some(child => child.parent_id === obj.id);
                                            const isSelected = selectedAnnotation === obj.id;
                                            const isEditing = editingBoxId === obj.id;
                                            
                                            return (
                                                <div
                                                    key={obj.id}
                                                    className={`bbox ${obj.type} ${isSelected ? 'selected' : ''} ${isEditing ? 'editing' : ''}`}
                                                    onMouseDown={(e) => handleBboxMouseDown(e, obj.id)}
                                                    style={{
                                                        left: `${left}px`,
                                                        top: `${top}px`,
                                                        width: `${width}px`,
                                                        height: `${height}px`,
                                                        position: 'absolute',
                                                        zIndex: isSelected ? 1000 : 100 - ((bbox[2] - bbox[0]) * (bbox[3] - bbox[1]) / 10000),

                                                        cursor: 'move',
                                                        pointerEvents: 'auto'
                                                    }}
                                                >

                                                    <div className="bbox-label">
                                                        {getAnnotationIcon(obj.type, obj.wheel_type)} {obj.type === 'vehicle' ? (vehicleForm.category || 'VEHICLE') : obj.type.replace('_', ' ').toUpperCase()}
                                                        {obj.type === 'wheel' && obj.wheel_type && ` (${obj.wheel_type.toUpperCase()})`}
                                                        {obj.type === 'vehicle' && vehicleForm.subcategory && ` (${vehicleForm.subcategory})`}
                                                    </div>

                                                    {hasChildren && (
                                                        <div className="connection-indicator">
                                                            {annotations.objects.filter(child => child.parent_id === obj.id).length}
                                                        </div>
                                                    )}
                                                    
                                                    {isSelected && (
                                                        <>
                                                            <div className="resize-handle nw" onMouseDown={(e) => handleBboxMouseDown(e, obj.id, 'nw')}></div>
                                                            <div className="resize-handle ne" onMouseDown={(e) => handleBboxMouseDown(e, obj.id, 'ne')}></div>
                                                            <div className="resize-handle sw" onMouseDown={(e) => handleBboxMouseDown(e, obj.id, 'sw')}></div>
                                                            <div className="resize-handle se" onMouseDown={(e) => handleBboxMouseDown(e, obj.id, 'se')}></div>
                                                            <div className="resize-handle n" onMouseDown={(e) => handleBboxMouseDown(e, obj.id, 'n')}></div>
                                                            <div className="resize-handle s" onMouseDown={(e) => handleBboxMouseDown(e, obj.id, 's')}></div>
                                                            <div className="resize-handle w" onMouseDown={(e) => handleBboxMouseDown(e, obj.id, 'w')}></div>
                                                            <div className="resize-handle e" onMouseDown={(e) => handleBboxMouseDown(e, obj.id, 'e')}></div>
                                                        </>
                                                    )}
                                                </div>
                                            );
                                        })}
                                        
                                        {/* Render current drawing box in fullscreen */}
                                        {currentBox && imageRef.current && fullscreenContainerRef.current && (
                                            (() => {
                                                const imageRect = imageRef.current.getBoundingClientRect();
                                                const containerRect = fullscreenContainerRef.current.getBoundingClientRect();
                                                
                                                const scaleX = imageRect.width / annotations.image.width;
                                                const scaleY = imageRect.height / annotations.image.height;
                                                
                                                const left = (imageRect.left - containerRect.left) + (currentBox.x * scaleX);
                                                const top = (imageRect.top - containerRect.top) + (currentBox.y * scaleY);
                                                const width = currentBox.width * scaleX;
                                                const height = currentBox.height * scaleY;
                                                
                                                return (
                                                    <div
                                                        className={`bbox ${annotationType}`}
                                                        style={{
                                                            left: `${left}px`,
                                                            top: `${top}px`,
                                                            width: `${width}px`,
                                                            height: `${height}px`,
                                                            position: 'absolute',
                                                            zIndex: 30
                                                        }}
                                                    >

                                                        <div className="bbox-label">
                                                            {getAnnotationIcon(annotationType)} {annotationType === 'vehicle' ? vehicleForm.category || 'VEHICLE' : annotationType.replace('_', ' ').toUpperCase()} [Drawing...]
                                                        </div>                                                        
                                                    </div>
                                                );
                                            })()
                                        )}
                                        
                                        {/* Magnifier in fullscreen */}
                                        {showMagnifier && magnifierEnabled && ( 
                                            <div
                                                style={{
                                                    position: 'fixed',
                                                    left: `${magnifierPosition.x}px`,
                                                    top: `${magnifierPosition.y}px`,
                                                    width: `${magnifierSize}px`,
                                                    height: `${magnifierSize}px`,
                                                    border: '3px solid #fff',
                                                    borderRadius: '50%',
                                                    boxShadow: '0 0 20px rgba(0,0,0,0.5)',
                                                    backgroundImage: `url(${imagePreview})`,
                                                    backgroundRepeat: 'no-repeat',
                                                    backgroundSize: `${annotations.image.width * magnificationLevel}px ${annotations.image.height * magnificationLevel}px`,
                                                    backgroundPosition: `-${magnifierImagePosition.x * magnificationLevel - magnifierSize/2}px -${magnifierImagePosition.y * magnificationLevel - magnifierSize/2}px`,
                                                    pointerEvents: 'none',
                                                    zIndex: 1000
                                                }}
                                            />
                                        )}
                                    </div>
                                    
                                    {/* Fullscreen zoom controls */}
                                    <div style={{
                                        position: 'absolute',
                                        bottom: '20px',
                                        left: '20px',
                                        display: 'flex',
                                        gap: '8px',
                                        background: 'rgba(0,0,0,0.8)',
                                        padding: '8px',
                                        borderRadius: '12px'
                                    }}>
                                        <button 
                                            onClick={handleZoomOut} 
                                            className="fullscreen-btn"
                                            style={{ width: '36px', height: '36px', padding: '0' }}
                                        >
                                            −
                                        </button>
                                        <div style={{
                                            color: 'white',
                                            fontSize: '12px',
                                            fontWeight: 'bold',
                                            display: 'flex',
                                            alignItems: 'center',
                                            padding: '0 8px'
                                        }}>
                                            {Math.round(zoomLevel * 100)}%
                                        </div>
                                        <button 
                                            onClick={handleZoomIn}
                                            className="fullscreen-btn"
                                            style={{ width: '36px', height: '36px', padding: '0' }}
                                        >
                                            +
                                        </button>
                                        <button 
                                            onClick={handleZoomReset}
                                            className="fullscreen-btn"
                                            style={{ width: '36px', height: '36px', padding: '0' }}
                                        >
                                            ⌂
                                        </button>
                                    </div>

                                    {/* Annotations list in fullscreen */}
                                    {annotations.objects.length > 0 && (
                                        <div style={{
                                            position: 'absolute',
                                            bottom: '80px',  // <-- MOVED UP FROM 20px TO 80px
                                            left: '20px',    // <-- ALIGNED WITH ZOOM CONTROLS
                                            background: 'rgba(0,0,0,0.9)',
                                            padding: '16px',
                                            borderRadius: '12px',
                                            maxWidth: '300px',
                                            maxHeight: '400px',
                                            overflowY: 'auto'
                                        }}>
                                            <div style={{
                                                color: 'white',
                                                fontSize: '14px',
                                                fontWeight: 'bold',
                                                marginBottom: '12px',
                                                display: 'flex',
                                                alignItems: 'center',
                                                gap: '8px'
                                            }}>
                                                📋 Annotations ({annotations.objects.length})
                                            </div>
                                            
                                            {annotations.objects.map((obj, index) => (
                                                <div 
                                                    key={obj.id}
                                                    onClick={() => setSelectedAnnotation(obj.id)}
                                                    style={{
                                                        padding: '8px 12px',
                                                        background: selectedAnnotation === obj.id ? 'rgba(255, 215, 0, 0.3)' : 'rgba(255,255,255,0.1)',
                                                        border: selectedAnnotation === obj.id ? '2px solid #ffd700' : '1px solid rgba(255,255,255,0.2)',
                                                        borderRadius: '6px',
                                                        marginBottom: '6px',
                                                        cursor: 'pointer',
                                                        display: 'flex',
                                                        justifyContent: 'space-between',
                                                        alignItems: 'center',
                                                        transition: 'all 0.2s ease'
                                                    }}
                                                >
                                                    <div>
                                                        <div style={{
                                                            color: 'white',
                                                            fontSize: '12px',
                                                            fontWeight: 'bold',
                                                            marginBottom: '2px'
                                                        }}>
                                                            {getAnnotationIcon(obj.type, obj.wheel_type)} {obj.type.replace('_', ' ').toUpperCase()}
                                                            {obj.type === 'wheel' && obj.wheel_type && ` (${obj.wheel_type.toUpperCase()})`}
                                                        </div>
                                                        <div style={{
                                                            color: '#ccc',
                                                            fontSize: '10px'
                                                        }}>
                                                            {Math.round(obj.bbox[2] - obj.bbox[0])}×{Math.round(obj.bbox[3] - obj.bbox[1])}px

                                                            {obj.license_plate?.text && (
                                                                <span> • {obj.license_plate.text}</span>
                                                            )}
                                                        </div>
                                                    </div>
                                                    <button
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            saveToHistory(annotations);
                                                            deleteAnnotation(obj.id);
                                                        }}
                                                        style={{
                                                            background: '#dc3545',
                                                            color: 'white',
                                                            border: 'none',
                                                            borderRadius: '4px',
                                                            padding: '4px 8px',
                                                            fontSize: '10px',
                                                            cursor: 'pointer'
                                                        }}
                                                    >
                                                        ✕
                                                    </button>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}                        
                    </div>
                </div>
            );
        };
        
        ReactDOM.render(<AdvancedVehicleAnnotationTool />, document.getElementById('root'));
    </script>
</body>
</html>








